<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/tests/ExpenseTrackerAPI.WebApi.Tests/E2E/Errors/TransactionGroupErrorFormatTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Net;
using System.Net.Http.Json;
using ExpenseTrackerAPI.Contracts.TransactionGroups;
using ExpenseTrackerAPI.WebApi.Tests.Common;
using ExpenseTrackerAPI.WebApi.Tests.Fixtures;
using FluentAssertions;

namespace ExpenseTrackerAPI.WebApi.Tests.E2E.Errors;

/// &lt;summary&gt;
/// Tests RFC 9110 compliant error response formats for TransactionGroup endpoints.
/// Validates that all error responses follow proper structure and error keys don&#39;t contain dots.
/// &lt;/summary&gt;
public class TransactionGroupErrorFormatTests : BaseE2ETest
{
    public TransactionGroupErrorFormatTests(ExpenseTrackerApiFactory factory) : base(factory) { }

    #region Create TransactionGroup Error Format Tests

    [Fact]
    public async Task CreateTransactionGroup_WithEmptyName_ShouldReturnValidationProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var request = new CreateTransactionGroupRequest(
            Name: &quot;&quot;,
            Description: &quot;Test Description&quot;);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();
        problemDetails.Should().NotBeNull();

        // Validate RFC 9110 compliance
        ErrorResponseValidator.IsValidValidationProblemDetails(problemDetails).Should().BeTrue(
            &quot;response should conform to RFC 9110 ProblemDetails format&quot;);

        // Validate no dots in error keys
        var invalidKeys = ErrorResponseValidator.GetInvalidKeys(problemDetails!.Errors);
        invalidKeys.Should().BeEmpty(
            $&quot;error keys should not contain dots, but found: {string.Join(&quot;, &quot;, invalidKeys)}&quot;);

        problemDetails.Status.Should().Be(400);
        problemDetails.Errors.Should().NotBeNull();
        problemDetails.Errors.Should().ContainKey(&quot;Name&quot;);
    }

    [Fact]
    public async Task CreateTransactionGroup_WithExcessivelyLongName_ShouldReturnValidationProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var tooLongName = new string(&#39;A&#39;, 256); // Exceeds 255 char limit
        var request = new CreateTransactionGroupRequest(
            Name: tooLongName,
            Description: &quot;Test Description&quot;);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidValidationProblemDetails(problemDetails).Should().BeTrue();
        ErrorResponseValidator.AllKeysAreValid(problemDetails!.Errors).Should().BeTrue(
            &quot;error keys should not contain dots&quot;);

        problemDetails.Errors.Should().ContainKey(&quot;Name&quot;);
    }

    [Fact]
    public async Task CreateTransactionGroup_WithNullName_ShouldReturnValidationProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var request = new CreateTransactionGroupRequest(
            Name: null!,
            Description: &quot;Test Description&quot;);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidValidationProblemDetails(problemDetails).Should().BeTrue();
        ErrorResponseValidator.AllKeysAreValid(problemDetails!.Errors).Should().BeTrue();

        problemDetails.Errors.Should().ContainKey(&quot;Name&quot;);
    }

    [Fact]
    public async Task CreateTransactionGroup_WithExcessivelyLongDescription_ShouldReturnValidationProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var tooLongDescription = new string(&#39;A&#39;, 1001); // Exceeds 1000 char limit
        var request = new CreateTransactionGroupRequest(
            Name: &quot;Valid Name&quot;,
            Description: tooLongDescription);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        if (response.StatusCode == HttpStatusCode.BadRequest)
        {
            var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

            ErrorResponseValidator.IsValidValidationProblemDetails(problemDetails).Should().BeTrue();
            ErrorResponseValidator.AllKeysAreValid(problemDetails!.Errors).Should().BeTrue();

            problemDetails.Errors.Should().ContainKey(&quot;Description&quot;);
        }
    }

    #endregion

    #region Get TransactionGroup Error Format Tests

    [Fact]
    public async Task GetTransactionGroup_WithNonExistentId_ShouldReturnNotFoundProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var nonExistentId = 999999;

        // Act
        var response = await Client.GetAsync(TestConstants.Routes.TransactionGroup(nonExistentId));

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.NotFound);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();
        problemDetails.Should().NotBeNull();

        // Validate RFC 9110 compliance
        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();

        problemDetails!.Status.Should().Be(404);
        problemDetails.Title.Should().NotBeNullOrEmpty();
    }

    [Fact]
    public async Task GetTransactionGroup_WithNegativeId_ShouldReturnBadRequestProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var invalidId = -1;

        // Act
        var response = await Client.GetAsync(TestConstants.Routes.TransactionGroup(invalidId));

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();

        problemDetails!.Status.Should().Be(400);
    }

    [Fact]
    public async Task GetTransactionGroup_WithZeroId_ShouldReturnBadRequestProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var invalidId = 0;

        // Act
        var response = await Client.GetAsync(TestConstants.Routes.TransactionGroup(invalidId));

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();
    }

    #endregion

    #region Update TransactionGroup Error Format Tests

    [Fact]
    public async Task UpdateTransactionGroup_WithNonExistentId_ShouldReturnNotFoundProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var nonExistentId = 999999;
        var request = new UpdateTransactionGroupRequest(
            Name: &quot;Updated Name&quot;,
            Description: &quot;Updated Description&quot;);

        // Act
        var response = await Client.PutAsJsonAsync(TestConstants.Routes.TransactionGroup(nonExistentId), request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.NotFound);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();

        problemDetails!.Status.Should().Be(404);
    }

    [Fact]
    public async Task UpdateTransactionGroup_WithEmptyName_ShouldReturnValidationProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var validId = 1; // Assuming a transaction group exists
        var request = new UpdateTransactionGroupRequest(
            Name: &quot;&quot;,
            Description: &quot;Updated Description&quot;);

        // Act
        var response = await Client.PutAsJsonAsync(TestConstants.Routes.TransactionGroup(validId), request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidValidationProblemDetails(problemDetails).Should().BeTrue();
        ErrorResponseValidator.AllKeysAreValid(problemDetails!.Errors).Should().BeTrue();

        problemDetails.Errors.Should().ContainKey(&quot;Name&quot;);
    }

    [Fact]
    public async Task UpdateTransactionGroup_WithInvalidId_ShouldReturnBadRequestProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var invalidId = -5;
        var request = new UpdateTransactionGroupRequest(
            Name: &quot;Updated Name&quot;,
            Description: &quot;Updated Description&quot;);

        // Act
        var response = await Client.PutAsJsonAsync(TestConstants.Routes.TransactionGroup(invalidId), request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();
    }

    [Fact]
    public async Task UpdateTransactionGroup_WithExcessivelyLongName_ShouldReturnValidationProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var validId = 1;
        var tooLongName = new string(&#39;B&#39;, 256);
        var request = new UpdateTransactionGroupRequest(
            Name: tooLongName,
            Description: &quot;Updated Description&quot;);

        // Act
        var response = await Client.PutAsJsonAsync(TestConstants.Routes.TransactionGroup(validId), request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidValidationProblemDetails(problemDetails).Should().BeTrue();
        ErrorResponseValidator.AllKeysAreValid(problemDetails!.Errors).Should().BeTrue();

        problemDetails.Errors.Should().ContainKey(&quot;Name&quot;);
    }

    #endregion

    #region Delete TransactionGroup Error Format Tests

    [Fact]
    public async Task DeleteTransactionGroup_WithNonExistentId_ShouldReturnNotFoundProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var nonExistentId = 999999;

        // Act
        var response = await Client.DeleteAsync(TestConstants.Routes.TransactionGroup(nonExistentId));

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.NotFound);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();

        problemDetails!.Status.Should().Be(404);
    }

    [Fact]
    public async Task DeleteTransactionGroup_WithInvalidId_ShouldReturnBadRequestProblemDetailsWithoutDotsInKeys()
    {
        // Arrange
        var invalidId = 0;

        // Act
        var response = await Client.DeleteAsync(TestConstants.Routes.TransactionGroup(invalidId));

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ProblemDetailsResponse&gt;();

        ErrorResponseValidator.IsValidProblemDetails(problemDetails).Should().BeTrue();
    }

    #endregion

    #region RFC 9110 Compliance Tests

    [Fact]
    public async Task AllTransactionGroupErrors_ShouldHaveProperStatusCodes()
    {
        // 400 Bad Request - validation error
        var validationRequest = new CreateTransactionGroupRequest(
            Name: &quot;&quot;,
            Description: &quot;Test&quot;);
        var validationResponse = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, validationRequest);
        validationResponse.StatusCode.Should().Be(HttpStatusCode.BadRequest);

        // 404 Not Found - resource doesn&#39;t exist
        var notFoundResponse = await Client.GetAsync(TestConstants.Routes.TransactionGroup(999999));
        notFoundResponse.StatusCode.Should().Be(HttpStatusCode.NotFound);
    }

    [Fact]
    public async Task AllTransactionGroupValidationErrors_ShouldIncludeRequiredProblemDetailsFields()
    {
        // Arrange
        var request = new CreateTransactionGroupRequest(
            Name: &quot;&quot;,
            Description: &quot;Test&quot;);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

        // RFC 9110 required fields
        problemDetails!.Status.Should().NotBeNull(&quot;status is required by RFC 9110&quot;);
        problemDetails.Status.Should().Be((int)response.StatusCode, &quot;status should match response code&quot;);

        // At least one of title or detail should be present
        var hasDescription = !string.IsNullOrWhiteSpace(problemDetails.Title) ||
                            !string.IsNullOrWhiteSpace(problemDetails.Detail);
        hasDescription.Should().BeTrue(&quot;either title or detail is required for problem description&quot;);
    }

    [Fact]
    public async Task AllTransactionGroupErrors_ShouldHaveTraceIdForDebugging()
    {
        // Arrange
        var request = new CreateTransactionGroupRequest(
            Name: &quot;&quot;,
            Description: &quot;Test&quot;);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

        problemDetails!.TraceId.Should().NotBeNullOrEmpty(&quot;traceId should be present for request tracking&quot;);
    }

    [Theory]
    [InlineData(&quot;&quot;)]
    [InlineData(null)]
    public async Task CreateTransactionGroup_ValidationErrors_ShouldNeverContainDotsInErrorKeys(string? name)
    {
        // Arrange
        var request = new CreateTransactionGroupRequest(
            Name: name!,
            Description: &quot;Test&quot;);

        // Act
        var response = await Client.PostAsJsonAsync(TestConstants.Routes.TransactionGroups, request);

        // Assert
        if (response.StatusCode == HttpStatusCode.BadRequest)
        {
            var problemDetails = await response.Content.ReadFromJsonAsync&lt;ValidationProblemDetailsResponse&gt;();

            if (problemDetails?.Errors != null)
            {
                var invalidKeys = ErrorResponseValidator.GetInvalidKeys(problemDetails.Errors);
                invalidKeys.Should().BeEmpty(
                    $&quot;error keys must not contain dots. Found invalid keys: {string.Join(&quot;, &quot;, invalidKeys)}&quot;);
            }
        }
    }

    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,81,16,94,1],[16,95,16,96,1],[16,97,16,98,1],[22,5,22,6,1],[24,9,26,46,1],[29,9,29,102,1],[32,9,32,68,1],[34,9,34,107,1],[35,9,35,45,1],[38,9,39,74,1],[42,9,42,89,1],[43,9,44,97,1],[46,9,46,48,1],[47,9,47,52,1],[48,9,48,59,1],[49,5,49,6,1],[53,5,53,6,1],[55,9,55,48,1],[56,9,58,46,1],[61,9,61,102,1],[64,9,64,68,1],[66,9,66,107,1],[68,9,68,98,1],[69,9,70,51,1],[72,9,72,59,1],[73,5,73,6,1],[77,5,77,6,1],[79,9,81,46,1],[84,9,84,102,1],[87,9,87,68,1],[89,9,89,107,1],[91,9,91,98,1],[92,9,92,90,1],[94,9,94,59,1],[95,5,95,6,1],[99,5,99,6,1],[101,9,101,56,1],[102,9,104,46,1],[107,9,107,102,1],[110,9,110,62,1],[111,9,111,10,0],[112,13,112,111,0],[114,13,114,102,0],[115,13,115,94,0],[117,13,117,70,0],[118,9,118,10,0],[119,5,119,6,1],[127,5,127,6,1],[129,9,129,36,1],[132,9,132,100,1],[135,9,135,66,1],[137,9,137,97,1],[138,9,138,45,1],[141,9,141,88,1],[143,9,143,49,1],[144,9,144,58,1],[145,5,145,6,1],[149,5,149,6,1],[151,9,151,28,1],[154,9,154,96,1],[157,9,157,68,1],[159,9,159,97,1],[161,9,161,88,1],[163,9,163,49,1],[164,5,164,6,1],[168,5,168,6,1],[170,9,170,27,1],[173,9,173,96,1],[176,9,176,68,1],[178,9,178,97,1],[180,9,180,88,1],[181,5,181,6,1],[189,5,189,6,1],[191,9,191,36,1],[192,9,194,49,1],[197,9,197,115,1],[200,9,200,66,1],[202,9,202,97,1],[204,9,204,88,1],[206,9,206,49,1],[207,5,207,6,1],[211,5,211,6,1],[213,9,213,25,1],[214,9,216,49,1],[219,9,219,109,1],[222,9,222,68,1],[224,9,224,107,1],[226,9,226,98,1],[227,9,227,90,1],[229,9,229,59,1],[230,5,230,6,1],[234,5,234,6,1],[236,9,236,28,1],[237,9,239,49,1],[242,9,242,111,1],[245,9,245,68,1],[247,9,247,97,1],[249,9,249,88,1],[250,5,250,6,1],[254,5,254,6,1],[256,9,256,25,1],[257,9,257,48,1],[258,9,260,49,1],[263,9,263,109,1],[266,9,266,68,1],[268,9,268,107,1],[270,9,270,98,1],[271,9,271,90,1],[273,9,273,59,1],[274,5,274,6,1],[282,5,282,6,1],[284,9,284,36,1],[287,9,287,103,1],[290,9,290,66,1],[292,9,292,97,1],[294,9,294,88,1],[296,9,296,49,1],[297,5,297,6,1],[301,5,301,6,1],[303,9,303,27,1],[306,9,306,99,1],[309,9,309,68,1],[311,9,311,97,1],[313,9,313,88,1],[314,5,314,6,1],[322,5,322,6,1],[324,9,326,34,1],[327,9,327,122,1],[328,9,328,78,1],[331,9,331,101,1],[332,9,332,74,1],[333,5,333,6,1],[337,5,337,6,1],[339,9,341,34,1],[344,9,344,102,1],[347,9,347,107,1],[350,9,350,85,1],[351,9,351,106,1],[354,9,355,79,1],[356,9,356,102,1],[357,5,357,6,1],[361,5,361,6,1],[363,9,365,34,1],[368,9,368,102,1],[371,9,371,107,1],[373,9,373,109,1],[374,5,374,6,1],[380,5,380,6,1],[382,9,384,34,1],[387,9,387,102,1],[390,9,390,62,1],[391,9,391,10,1],[392,13,392,111,1],[394,13,394,48,1],[395,13,395,14,1],[396,17,396,96,1],[397,17,398,112,1],[399,13,399,14,1],[400,9,400,10,1],[401,5,401,6,1]]);
    </script>
  </body>
</html>