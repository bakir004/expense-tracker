<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/src/ExpenseTrackerAPI.Domain/Entities/Transaction.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ExpenseTrackerAPI.Domain.Errors;

namespace ExpenseTrackerAPI.Domain.Entities;

/// &lt;summary&gt;
/// Represents a financial transaction (expense or income) in the expense tracker system.
/// This is a unified model that handles both expenses and income with type-specific fields.
/// &lt;/summary&gt;
public class Transaction
{
    // Private constructor for EF Core
    private Transaction() { }

    /// &lt;summary&gt;
    /// Creates a new transaction with business rule validation
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;userId&quot;&gt;The user who owns this transaction&lt;/param&gt;
    /// &lt;param name=&quot;transactionType&quot;&gt;Type of transaction (EXPENSE or INCOME)&lt;/param&gt;
    /// &lt;param name=&quot;amount&quot;&gt;The transaction amount (must be positive)&lt;/param&gt;
    /// &lt;param name=&quot;date&quot;&gt;The date of the transaction&lt;/param&gt;
    /// &lt;param name=&quot;subject&quot;&gt;Brief description of the transaction&lt;/param&gt;
    /// &lt;param name=&quot;paymentMethod&quot;&gt;How the transaction was paid&lt;/param&gt;
    /// &lt;param name=&quot;notes&quot;&gt;Optional additional notes&lt;/param&gt;
    /// &lt;param name=&quot;categoryId&quot;&gt;Category ID (optional for both expenses and income)&lt;/param&gt;
    /// &lt;param name=&quot;transactionGroupId&quot;&gt;Optional transaction group ID&lt;/param&gt;
    /// &lt;param name=&quot;createdAt&quot;&gt;Optional creation timestamp (defaults to current UTC time)&lt;/param&gt;
    /// &lt;param name=&quot;updatedAt&quot;&gt;Optional update timestamp (defaults to current UTC time)&lt;/param&gt;

    public Transaction(
        int userId,
        TransactionType transactionType,
        decimal amount,
        DateOnly date,
        string subject,
        PaymentMethod paymentMethod,
        string? notes = null,
        int? categoryId = null,
        int? transactionGroupId = null,
        DateTime? createdAt = null,
        DateTime? updatedAt = null)
    {
        ValidateBusinessRules(userId, transactionType, amount, date, subject, categoryId);

        UserId = userId;
        TransactionType = transactionType;
        Amount = amount;
        SignedAmount = transactionType == TransactionType.EXPENSE ? -amount : amount;
        Date = date;
        Subject = subject.Trim();
        Notes = string.IsNullOrWhiteSpace(notes) ? null : notes.Trim();
        PaymentMethod = paymentMethod;
        CategoryId = categoryId;
        TransactionGroupId = transactionGroupId;

        var now = DateTime.UtcNow;
        CreatedAt = createdAt ?? now;
        UpdatedAt = updatedAt ?? now;

        CumulativeDelta = 0;
    }

    /// &lt;summary&gt;
    /// Updates the cumulative delta for this transaction (called by domain services)
    /// &lt;/summary&gt;
    public void UpdateCumulativeDelta(decimal cumulativeDelta)
    {
        CumulativeDelta = cumulativeDelta;
        UpdatedAt = DateTime.UtcNow;
    }

    public void UpdateId(int id)
    {
        Id = id;
    }

    /// &lt;summary&gt;
    /// Validates business rules for transaction creation
    /// Throws ArgumentException if validation fails
    /// &lt;/summary&gt;
    private static void ValidateBusinessRules(
        int userId,
        TransactionType transactionType,
        decimal amount,
        DateOnly date,
        string subject,
        int? categoryId)
    {
        if (userId &lt;= 0)
        {
            throw new ArgumentException(&quot;User ID must be a positive integer.&quot;, nameof(userId));
        }

        if (amount &lt;= 0)
        {
            throw new ArgumentException(&quot;Transaction amount must be greater than zero.&quot;, nameof(amount));
        }

        var minDate = new DateOnly(1900, 1, 1);
        var maxDate = DateOnly.FromDateTime(DateTime.Now.AddYears(1));

        if (date &lt; minDate || date &gt; maxDate)
        {
            throw new ArgumentException($&quot;Transaction date must be between {minDate:yyyy-MM-dd} and {maxDate:yyyy-MM-dd}.&quot;, nameof(date));
        }

        if (string.IsNullOrWhiteSpace(subject))
        {
            throw new ArgumentException(&quot;Transaction subject is required and cannot be empty.&quot;, nameof(subject));
        }

        if (subject.Trim().Length &gt; 255)
        {
            throw new ArgumentException(&quot;Transaction subject cannot exceed 255 characters.&quot;, nameof(subject));
        }

        if (transactionType != TransactionType.EXPENSE &amp;&amp; transactionType != TransactionType.INCOME)
        {
            throw new ArgumentException(&quot;Invalid transaction type. Must be &#39;EXPENSE&#39; or &#39;INCOME&#39;.&quot;, nameof(transactionType));
        }

        if (categoryId.HasValue &amp;&amp; categoryId.Value &lt;= 0)
        {
            throw new ArgumentException(&quot;Category ID must be a positive integer when provided.&quot;, nameof(categoryId));
        }
    }

    public int Id { get; private set; }

    public int UserId { get; }

    /// &lt;summary&gt;
    /// The type of transaction: Expense or Income
    /// &lt;/summary&gt;
    public TransactionType TransactionType { get; }

    /// &lt;summary&gt;
    /// The absolute amount (always positive)
    /// &lt;/summary&gt;
    public decimal Amount { get; }

    /// &lt;summary&gt;
    /// The signed amount: negative for expenses, positive for income
    /// &lt;/summary&gt;
    public decimal SignedAmount { get; }

    /// &lt;summary&gt;
    /// The date of the transaction (date only, no time component).
    /// &lt;/summary&gt;
    public DateOnly Date { get; }

    /// &lt;summary&gt;
    /// Brief description of what/why this transaction occurred.
    /// Examples: &quot;Grocery shopping&quot;, &quot;Monthly salary&quot;, &quot;Flight tickets&quot;
    /// &lt;/summary&gt;
    public string Subject { get; } = string.Empty;

    /// &lt;summary&gt;
    /// Optional longer description with additional details.
    /// &lt;/summary&gt;
    public string? Notes { get; }

    public PaymentMethod PaymentMethod { get; }

    /// &lt;summary&gt;
    /// Running sum of all signed_amounts up to and including this transaction.
    /// Actual balance = User.InitialBalance + CumulativeDelta
    /// &lt;/summary&gt;
    public decimal CumulativeDelta { get; private set; }

    /// &lt;summary&gt;
    /// Category of the transaction. Optional for both expenses and income.
    /// &lt;/summary&gt;
    public int? CategoryId { get; }

    /// &lt;summary&gt;
    /// Transaction group for grouping related transactions (e.g., vacation, project, wedding).
    /// Applicable for both expenses and income.
    /// &lt;/summary&gt;
    public int? TransactionGroupId { get; }

    public DateTime CreatedAt { get; }
    public DateTime UpdatedAt { get; private set; }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[12,5,12,26,1],[12,27,12,28,1],[12,29,12,30,1],[29,5,40,36,1],[41,5,41,6,1],[42,9,42,91,1],[44,9,44,25,1],[45,9,45,43,1],[46,9,46,25,1],[47,9,47,86,1],[48,9,48,21,1],[49,9,49,34,1],[50,9,50,72,1],[51,9,51,39,1],[52,9,52,33,1],[53,9,53,49,1],[55,9,55,35,1],[56,9,56,38,1],[57,9,57,38,1],[59,9,59,29,1],[60,5,60,6,1],[66,5,66,6,1],[67,9,67,43,1],[68,9,68,37,1],[69,5,69,6,1],[72,5,72,6,1],[73,9,73,17,1],[74,5,74,6,1],[87,5,87,6,1],[88,9,88,25,1],[89,9,89,10,1],[90,13,90,96,1],[93,9,93,25,1],[94,9,94,10,1],[95,13,95,106,1],[98,9,98,48,1],[99,9,99,71,1],[101,9,101,46,1],[102,9,102,10,1],[103,13,103,139,1],[106,9,106,48,1],[107,9,107,10,1],[108,13,108,114,1],[111,9,111,41,1],[112,9,112,10,1],[113,13,113,111,1],[116,9,116,101,1],[117,9,117,10,0],[118,13,118,126,0],[121,9,121,58,1],[122,9,122,10,1],[123,13,123,118,1],[125,5,125,6,1],[155,38,155,50,1],[155,38,155,50,1]]);
    </script>
  </body>
</html>