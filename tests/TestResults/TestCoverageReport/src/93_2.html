<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/src/ExpenseTrackerAPI.Application/Transactions/TransactionService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ErrorOr;
using ExpenseTrackerAPI.Domain.Entities;
using ExpenseTrackerAPI.Domain.Errors;
using ExpenseTrackerAPI.Application.Transactions.Interfaces.Application;
using ExpenseTrackerAPI.Application.Transactions.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Application.Users.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Contracts.Transactions;

namespace ExpenseTrackerAPI.Application.Transactions;

/// &lt;summary&gt;
/// Application service for transaction operations.
/// Orchestrates domain logic and coordinates with the repository.
/// &lt;/summary&gt;
public class TransactionService : ITransactionService
{
    private readonly ITransactionRepository _transactionRepository;
    private readonly IUserRepository _userRepository;

    public TransactionService(
        ITransactionRepository transactionRepository,
        IUserRepository userRepository)
    {
        _transactionRepository = transactionRepository ?? throw new ArgumentNullException(nameof(transactionRepository));
        _userRepository = userRepository ?? throw new ArgumentNullException(nameof(userRepository));
    }

    public async Task&lt;ErrorOr&lt;Transaction&gt;&gt; GetByIdAsync(int id, CancellationToken cancellationToken)
    {
        return await _transactionRepository.GetByIdAsync(id, cancellationToken);
    }

    public async Task&lt;ErrorOr&lt;Transaction&gt;&gt; CreateAsync(
        int userId,
        TransactionType transactionType,
        decimal amount,
        DateOnly date,
        string subject,
        string? notes,
        PaymentMethod paymentMethod,
        int? categoryId,
        int? transactionGroupId,
        CancellationToken cancellationToken)
    {
        try
        {
            var transaction = new Transaction(
                userId: userId,
                transactionType: transactionType,
                amount: amount,
                date: date,
                subject: subject,
                paymentMethod: paymentMethod,
                notes: notes,
                categoryId: categoryId,
                transactionGroupId: transactionGroupId);

            return await _transactionRepository.CreateAsync(transaction, cancellationToken);
        }
        catch (ArgumentException ex)
        {
            return TransactionErrors.ValidationError(ex.Message);
        }
    }

    public async Task&lt;ErrorOr&lt;Transaction&gt;&gt; UpdateAsync(
        int id,
        int userId,
        TransactionType transactionType,
        decimal amount,
        DateOnly date,
        string subject,
        string? notes,
        PaymentMethod paymentMethod,
        int? categoryId,
        int? transactionGroupId,
        CancellationToken cancellationToken)
    {
        try
        {
            var oldTransaction = await _transactionRepository.GetByIdAsync(id, cancellationToken);
            if (oldTransaction.IsError)
            {
                return oldTransaction.Errors;
            }

            var existingTransaction = oldTransaction.Value;

            if (userId != existingTransaction.UserId)
                return TransactionErrors.Unauthorized;

            var updatedTransaction = new Transaction(
                userId: existingTransaction.UserId,
                transactionType: transactionType,
                amount: amount,
                date: date,
                subject: subject,
                paymentMethod: paymentMethod,
                notes: notes,
                categoryId: categoryId,
                transactionGroupId: transactionGroupId);

            updatedTransaction.UpdateId(id);

            return await _transactionRepository.UpdateAsync(existingTransaction, updatedTransaction, cancellationToken);
        }
        catch (ArgumentException ex)
        {
            return TransactionErrors.ValidationError(ex.Message);
        }
    }

    public async Task&lt;ErrorOr&lt;Deleted&gt;&gt; DeleteAsync(int id, int userId, CancellationToken cancellationToken)
    {
        var existingTransaction = await _transactionRepository.GetByIdAsync(id, cancellationToken);

        if (existingTransaction.IsError)
            return existingTransaction.Errors;

        var transactionOwnerId = existingTransaction.Value.UserId;

        if (transactionOwnerId != userId)
            return TransactionErrors.NotFound;

        return await _transactionRepository.DeleteAsync(id, cancellationToken);
    }

    public async Task&lt;ErrorOr&lt;TransactionFilterResponse&gt;&gt; GetByUserIdWithFilterAsync(
        int userId,
        TransactionFilter filter,
        CancellationToken cancellationToken)
    {
        // Verify user exists
        var userResult = await _userRepository.GetByIdAsync(userId, cancellationToken);
        if (userResult.IsError)
        {
            return UserErrors.NotFound;
        }

        var result = await _transactionRepository.GetByUserIdWithFilterAsync(userId, filter, cancellationToken);

        if (result.IsError)
        {
            return result.Errors;
        }

        var transactions = result.Value;

        return new TransactionFilterResponse
        {
            Transactions = transactions.Select(t =&gt; t.ToResponse()).ToList()
        };
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,5,22,40,1],[23,5,23,6,1],[24,9,24,122,1],[25,9,25,101,1],[26,5,26,6,1],[29,5,29,6,1],[30,9,30,81,1],[31,5,31,6,1],[44,5,44,6,1],[46,9,46,10,1],[47,13,56,57,1],[58,13,58,93,1],[60,9,60,37,1],[61,9,61,10,1],[62,13,62,66,1],[64,5,64,6,1],[78,5,78,6,1],[80,9,80,10,1],[81,13,81,99,1],[82,13,82,40,1],[83,13,83,14,1],[84,17,84,46,1],[87,13,87,60,1],[89,13,89,54,1],[90,17,90,55,0],[92,13,101,57,1],[103,13,103,45,1],[105,13,105,121,1],[107,9,107,37,0],[108,9,108,10,0],[109,13,109,66,0],[111,5,111,6,1],[114,5,114,6,1],[115,9,115,100,1],[117,9,117,41,1],[118,13,118,47,1],[120,9,120,67,1],[122,9,122,42,1],[123,13,123,47,1],[125,9,125,80,1],[126,5,126,6,1],[132,5,132,6,1],[134,9,134,88,1],[135,9,135,32,1],[136,9,136,10,1],[137,13,137,40,1],[140,9,140,113,1],[142,9,142,28,1],[143,9,143,10,1],[144,13,144,34,1],[147,9,147,41,1],[149,9,151,53,1],[151,53,151,67,1],[151,67,152,11,1],[153,5,153,6,1]]);
    </script>
  </body>
</html>