<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/tests/ExpenseTrackerAPI.Infrastructure.Tests/Repositories/UserRepositoryTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ExpenseTrackerAPI.Domain.Entities;
using ExpenseTrackerAPI.Infrastructure.Tests.Fixtures;
using ExpenseTrackerAPI.Infrastructure.Users;
using FluentAssertions;

namespace ExpenseTrackerAPI.Infrastructure.Tests.Repositories;

[Collection(nameof(DatabaseCollection))]
public class UserRepositoryTests
{
    private readonly DatabaseFixture _fixture;

    public UserRepositoryTests(DatabaseFixture fixture)
    {
        _fixture = fixture;
    }

    [Fact]
    public async Task CreateAsync_WithValidUser_ShouldCreateUser()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;John Doe&quot;,
            email: &quot;john.doe@example.com&quot;,
            passwordHash: &quot;hashed_password&quot;,
            initialBalance: 0
        );

        // Act
        var result = await sut.CreateAsync(user, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Id.Should().BeGreaterThan(0);
        result.Value.Name.Should().Be(&quot;John Doe&quot;);
        result.Value.Email.Should().Be(&quot;john.doe@example.com&quot;);
    }

    [Fact]
    public async Task GetByIdAsync_WithExistingUser_ShouldReturnUser()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Jane Smith&quot;,
            email: &quot;jane.smith@example.com&quot;,
            passwordHash: &quot;hashed_password&quot;,
            initialBalance: 0
        );
        var createResult = await sut.CreateAsync(user, CancellationToken.None);
        var userId = createResult.Value.Id;

        // Act
        var result = await sut.GetByIdAsync(userId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Id.Should().Be(userId);
        result.Value.Name.Should().Be(&quot;Jane Smith&quot;);
        result.Value.Email.Should().Be(&quot;jane.smith@example.com&quot;);
    }

    [Fact]
    public async Task GetByIdAsync_WithNonExistentUser_ShouldReturnError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var nonExistentId = 99999;

        // Act
        var result = await sut.GetByIdAsync(nonExistentId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;User&quot;);
    }

    [Fact]
    public async Task GetByEmailAsync_WithExistingEmail_ShouldReturnUser()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Bob Johnson&quot;,
            email: &quot;bob.johnson@example.com&quot;,
            passwordHash: &quot;hashed_password&quot;,
            initialBalance: 0
        );
        await sut.CreateAsync(user, CancellationToken.None);

        // Act
        var result = await sut.GetByEmailAsync(&quot;bob.johnson@example.com&quot;, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Email.Should().Be(&quot;bob.johnson@example.com&quot;);
        result.Value.Name.Should().Be(&quot;Bob Johnson&quot;);
    }

    [Fact]
    public async Task GetByEmailAsync_WithNonExistentEmail_ShouldReturnError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);

        // Act
        var result = await sut.GetByEmailAsync(&quot;nonexistent@example.com&quot;, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;User&quot;);
    }

    [Fact]
    public async Task ExistsByEmailAsync_WithExistingEmail_ShouldReturnTrue()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Alice Williams&quot;,
            email: &quot;alice.williams@example.com&quot;,
            passwordHash: &quot;hashed_password&quot;,
            initialBalance: 0
        );
        await sut.CreateAsync(user, CancellationToken.None);

        // Act
        var result = await sut.ExistsByEmailAsync(&quot;alice.williams@example.com&quot;, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().BeTrue();
    }

    [Fact]
    public async Task ExistsByEmailAsync_WithNonExistentEmail_ShouldReturnFalse()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);

        // Act
        var result = await sut.ExistsByEmailAsync(&quot;nonexistent@example.com&quot;, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().BeFalse();
    }

    [Fact]
    public async Task GetAllAsync_WithMultipleUsers_ShouldReturnAllUsers()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var users = new[]
        {
            new User(
                name: &quot;User One&quot;,
                email: &quot;user1@example.com&quot;,
                passwordHash: &quot;hash1&quot;,
                initialBalance: 0
            ),
            new User(
                name: &quot;User Two&quot;,
                email: &quot;user2@example.com&quot;,
                passwordHash: &quot;hash2&quot;,
                initialBalance: 100
            ),
            new User(
                name: &quot;User Three&quot;,
                email: &quot;user3@example.com&quot;,
                passwordHash: &quot;hash3&quot;,
                initialBalance: 50
            )
        };

        foreach (var user in users)
        {
            await sut.CreateAsync(user, CancellationToken.None);
        }

        // Act
        var result = await sut.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Should().HaveCount(3);
        result.Value.Should().Contain(u =&gt; u.Email == &quot;user1@example.com&quot;);
        result.Value.Should().Contain(u =&gt; u.Email == &quot;user2@example.com&quot;);
        result.Value.Should().Contain(u =&gt; u.Email == &quot;user3@example.com&quot;);
    }

    [Fact]
    public async Task GetAllAsync_WithNoUsers_ShouldReturnEmptyList()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);

        // Act
        var result = await sut.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Should().BeEmpty();
    }

    [Fact]
    public async Task UpdateAsync_WithValidUser_ShouldUpdateUser()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Original Name&quot;,
            email: &quot;original@example.com&quot;,
            passwordHash: &quot;original_hash&quot;,
            initialBalance: 0
        );
        var createResult = await sut.CreateAsync(user, CancellationToken.None);
        var createdUser = createResult.Value;

        // Modify the user
        createdUser.UpdateProfile(&quot;Updated Name&quot;, &quot;updated@example.com&quot;);

        // Act
        var result = await sut.UpdateAsync(createdUser, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Id.Should().Be(createdUser.Id);
        result.Value.Name.Should().Be(&quot;Updated Name&quot;);
        result.Value.Email.Should().Be(&quot;updated@example.com&quot;);

        // Verify persistence
        var getResult = await sut.GetByIdAsync(createdUser.Id, CancellationToken.None);
        getResult.Value.Name.Should().Be(&quot;Updated Name&quot;);
        getResult.Value.Email.Should().Be(&quot;updated@example.com&quot;);
    }

    [Fact]
    public async Task UpdateAsync_WithNonExistentUser_ShouldReturnError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Non Existent&quot;,
            email: &quot;nonexistent@example.com&quot;,
            passwordHash: &quot;hash&quot;,
            initialBalance: 0
        );

        // We need to somehow set the Id to a non-existent value
        // Since User has private setter for Id, we&#39;ll create and delete a user
        var createResult = await sut.CreateAsync(user, CancellationToken.None);
        createResult.IsError.Should().BeFalse();
        var userId = createResult.Value.Id;
        await sut.DeleteAsync(userId, CancellationToken.None);

        // Now try to update the deleted user
        var result = await sut.UpdateAsync(createResult.Value, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;User&quot;);
    }

    [Fact]
    public async Task DeleteAsync_WithExistingUser_ShouldDeleteUser()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;To Be Deleted&quot;,
            email: &quot;delete.me@example.com&quot;,
            passwordHash: &quot;hash&quot;,
            initialBalance: 0
        );
        var createResult = await sut.CreateAsync(user, CancellationToken.None);
        createResult.IsError.Should().BeFalse();
        var userId = createResult.Value.Id;

        // Act
        var result = await sut.DeleteAsync(userId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();

        // Verify user is deleted
        var getResult = await sut.GetByIdAsync(userId, CancellationToken.None);
        getResult.IsError.Should().BeTrue();
        getResult.FirstError.Code.Should().Be(&quot;User&quot;);
    }

    [Fact]
    public async Task DeleteAsync_WithNonExistentUser_ShouldReturnError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var nonExistentId = 99999;

        // Act
        var result = await sut.DeleteAsync(nonExistentId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;User&quot;);
    }

    [Fact]
    public async Task CreateAsync_WithDuplicateEmail_ShouldReturnError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user1 = new User(
            name: &quot;First User&quot;,
            email: &quot;duplicate@example.com&quot;,
            passwordHash: &quot;hash1&quot;,
            initialBalance: 0
        );
        await sut.CreateAsync(user1, CancellationToken.None);

        var user2 = new User(
            name: &quot;Second User&quot;,
            email: &quot;duplicate@example.com&quot;, // Same email
            passwordHash: &quot;hash2&quot;,
            initialBalance: 0
        );

        // Act
        var result = await sut.CreateAsync(user2, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;Email&quot;);
    }

    [Fact]
    public async Task CreateAsync_WithInitialBalance_ShouldCreateUserWithBalance()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;User With Balance&quot;,
            email: &quot;balance@example.com&quot;,
            passwordHash: &quot;hash&quot;,
            initialBalance: 1000.50m
        );

        // Act
        var result = await sut.CreateAsync(user, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.InitialBalance.Should().Be(1000.50m);

        // Verify persistence
        var getResult = await sut.GetByIdAsync(result.Value.Id, CancellationToken.None);
        getResult.Value.InitialBalance.Should().Be(1000.50m);
    }

    [Fact]
    public async Task UpdateAsync_WithPasswordChange_ShouldUpdatePassword()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Test User&quot;,
            email: &quot;test@example.com&quot;,
            passwordHash: &quot;original_hash&quot;,
            initialBalance: 0
        );
        var createResult = await sut.CreateAsync(user, CancellationToken.None);
        createResult.IsError.Should().BeFalse();
        var createdUser = createResult.Value;

        // Change password
        createdUser.UpdatePassword(&quot;new_hash&quot;);

        // Act
        var result = await sut.UpdateAsync(createdUser, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.PasswordHash.Should().Be(&quot;new_hash&quot;);

        // Verify persistence
        var getResult = await sut.GetByIdAsync(createdUser.Id, CancellationToken.None);
        getResult.Value.PasswordHash.Should().Be(&quot;new_hash&quot;);
    }

    [Fact]
    public async Task UpdateAsync_WithInitialBalanceChange_ShouldUpdateBalance()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Test User&quot;,
            email: &quot;test@example.com&quot;,
            passwordHash: &quot;hash&quot;,
            initialBalance: 100.00m
        );
        var createResult = await sut.CreateAsync(user, CancellationToken.None);
        createResult.IsError.Should().BeFalse();
        var createdUser = createResult.Value;

        // Change initial balance
        createdUser.UpdateInitialBalance(500.00m);

        // Act
        var result = await sut.UpdateAsync(createdUser, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.InitialBalance.Should().Be(500.00m);

        // Verify persistence
        var getResult = await sut.GetByIdAsync(createdUser.Id, CancellationToken.None);
        getResult.Value.InitialBalance.Should().Be(500.00m);
    }

    [Fact]
    public async Task GetByEmailAsync_WithCaseInsensitiveEmail_ShouldReturnUser()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Case Test User&quot;,
            email: &quot;casesensitive@example.com&quot;,
            passwordHash: &quot;hash&quot;,
            initialBalance: 0
        );
        await sut.CreateAsync(user, CancellationToken.None);

        // Act - search with different casing
        var result = await sut.GetByEmailAsync(&quot;CaseSensitive@Example.COM&quot;, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Email.Should().Be(&quot;casesensitive@example.com&quot;);
    }

    [Fact]
    public async Task ExistsByEmailAsync_WithCaseInsensitiveEmail_ShouldReturnTrue()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Case Test User&quot;,
            email: &quot;anothercase@example.com&quot;,
            passwordHash: &quot;hash&quot;,
            initialBalance: 0
        );
        await sut.CreateAsync(user, CancellationToken.None);

        // Act - check with different casing
        var result = await sut.ExistsByEmailAsync(&quot;AnotherCase@Example.COM&quot;, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().BeTrue();
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[13,5,13,56,1],[14,5,14,6,1],[15,9,15,28,1],[16,5,16,6,1],[20,5,20,6,1],[22,9,22,45,1],[23,9,23,58,1],[24,9,29,11,1],[32,9,32,74,1],[35,9,35,43,1],[36,9,36,43,1],[37,9,37,51,1],[38,9,38,51,1],[39,9,39,64,1],[40,5,40,6,1],[44,5,44,6,1],[46,9,46,45,1],[47,9,47,58,1],[48,9,53,11,1],[54,9,54,80,1],[55,9,55,44,1],[58,9,58,77,1],[61,9,61,43,1],[62,9,62,43,1],[63,9,63,45,1],[64,9,64,53,1],[65,9,65,66,1],[66,5,66,6,1],[70,5,70,6,1],[72,9,72,45,1],[73,9,73,58,1],[74,9,74,35,1],[77,9,77,84,1],[80,9,80,42,1],[81,9,81,52,1],[82,5,82,6,1],[86,5,86,6,1],[88,9,88,45,1],[89,9,89,58,1],[90,9,95,11,1],[96,9,96,61,1],[99,9,99,99,1],[102,9,102,43,1],[103,9,103,43,1],[104,9,104,67,1],[105,9,105,54,1],[106,5,106,6,1],[110,5,110,6,1],[112,9,112,45,1],[113,9,113,58,1],[116,9,116,99,1],[119,9,119,42,1],[120,9,120,52,1],[121,5,121,6,1],[125,5,125,6,1],[127,9,127,45,1],[128,9,128,58,1],[129,9,134,11,1],[135,9,135,61,1],[138,9,138,105,1],[141,9,141,43,1],[142,9,142,40,1],[143,5,143,6,1],[147,5,147,6,1],[149,9,149,45,1],[150,9,150,58,1],[153,9,153,102,1],[156,9,156,43,1],[157,9,157,41,1],[158,5,158,6,1],[162,5,162,6,1],[164,9,164,45,1],[165,9,165,58,1],[166,9,186,11,1],[188,9,188,16,1],[188,18,188,26,1],[188,27,188,29,1],[188,30,188,35,1],[189,9,189,10,1],[190,13,190,65,1],[191,9,191,10,1],[194,9,194,68,1],[197,9,197,43,1],[198,9,198,43,1],[199,9,199,44,1],[200,9,200,76,1],[201,9,201,76,1],[202,9,202,76,1],[203,5,203,6,1],[207,5,207,6,1],[209,9,209,45,1],[210,9,210,58,1],[213,9,213,68,1],[216,9,216,43,1],[217,9,217,43,1],[218,9,218,41,1],[219,5,219,6,1],[223,5,223,6,1],[225,9,225,45,1],[226,9,226,58,1],[227,9,232,11,1],[233,9,233,80,1],[234,9,234,46,1],[237,9,237,74,1],[240,9,240,81,1],[243,9,243,43,1],[244,9,244,43,1],[245,9,245,53,1],[246,9,246,55,1],[247,9,247,63,1],[250,9,250,88,1],[251,9,251,58,1],[252,9,252,66,1],[253,5,253,6,1],[257,5,257,6,1],[259,9,259,45,1],[260,9,260,58,1],[261,9,266,11,1],[270,9,270,80,1],[271,9,271,49,1],[272,9,272,44,1],[273,9,273,63,1],[276,9,276,88,1],[279,9,279,42,1],[280,9,280,52,1],[281,5,281,6,1],[285,5,285,6,1],[287,9,287,45,1],[288,9,288,58,1],[289,9,294,11,1],[295,9,295,80,1],[296,9,296,49,1],[297,9,297,44,1],[300,9,300,76,1],[303,9,303,43,1],[306,9,306,80,1],[307,9,307,45,1],[308,9,308,55,1],[309,5,309,6,1],[313,5,313,6,1],[315,9,315,45,1],[316,9,316,58,1],[317,9,317,35,1],[320,9,320,83,1],[323,9,323,42,1],[324,9,324,52,1],[325,5,325,6,1],[329,5,329,6,1],[331,9,331,45,1],[332,9,332,58,1],[333,9,338,11,1],[339,9,339,62,1],[341,9,346,11,1],[349,9,349,75,1],[352,9,352,42,1],[353,9,353,53,1],[354,5,354,6,1],[358,5,358,6,1],[360,9,360,45,1],[361,9,361,58,1],[362,9,367,11,1],[370,9,370,74,1],[373,9,373,43,1],[374,9,374,59,1],[377,9,377,89,1],[378,9,378,62,1],[379,5,379,6,1],[383,5,383,6,1],[385,9,385,45,1],[386,9,386,58,1],[387,9,392,11,1],[393,9,393,80,1],[394,9,394,49,1],[395,9,395,46,1],[398,9,398,48,1],[401,9,401,81,1],[404,9,404,43,1],[405,9,405,59,1],[408,9,408,88,1],[409,9,409,62,1],[410,5,410,6,1],[414,5,414,6,1],[416,9,416,45,1],[417,9,417,58,1],[418,9,423,11,1],[424,9,424,80,1],[425,9,425,49,1],[426,9,426,46,1],[429,9,429,51,1],[432,9,432,81,1],[435,9,435,43,1],[436,9,436,58,1],[439,9,439,88,1],[440,9,440,61,1],[441,5,441,6,1],[445,5,445,6,1],[447,9,447,45,1],[448,9,448,58,1],[449,9,454,11,1],[455,9,455,61,1],[458,9,458,101,1],[461,9,461,43,1],[462,9,462,69,1],[463,5,463,6,1],[467,5,467,6,1],[469,9,469,45,1],[470,9,470,58,1],[471,9,476,11,1],[477,9,477,61,1],[480,9,480,102,1],[483,9,483,43,1],[484,9,484,40,1],[485,5,485,6,1]]);
    </script>
  </body>
</html>