<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/src/ExpenseTrackerAPI.Infrastructure/Users/UserRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ErrorOr;
using Microsoft.EntityFrameworkCore;
using ExpenseTrackerAPI.Application.Users.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Domain.Entities;
using ExpenseTrackerAPI.Domain.Errors;
using ExpenseTrackerAPI.Infrastructure.Persistence;

namespace ExpenseTrackerAPI.Infrastructure.Users;

/// &lt;summary&gt;
/// EF Core implementation of the user repository.
/// Provides basic CRUD operations for user management.
/// &lt;/summary&gt;
public class UserRepository : IUserRepository
{
    private readonly ApplicationDbContext _context;

    public UserRepository(ApplicationDbContext context)
    {
        _context = context ?? throw new ArgumentNullException(nameof(context));
    }

    public async Task&lt;ErrorOr&lt;List&lt;User&gt;&gt;&gt; GetAllAsync(CancellationToken cancellationToken)
    {
        try
        {
            var users = await _context.Users
                .OrderBy(u =&gt; u.Name)
                .ToListAsync(cancellationToken);

            return users;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.GetAll.DatabaseError&quot;, $&quot;Failed to retrieve users: {ex.Message}&quot;);
        }
    }

    public async Task&lt;ErrorOr&lt;User&gt;&gt; GetByIdAsync(int id, CancellationToken cancellationToken)
    {
        try
        {
            var user = await _context.Users
                .FirstOrDefaultAsync(u =&gt; u.Id == id, cancellationToken);

            if (user is null)
                return UserErrors.NotFound;

            return user;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.GetById.DatabaseError&quot;, $&quot;Failed to retrieve user: {ex.Message}&quot;);
        }
    }

    public async Task&lt;ErrorOr&lt;User&gt;&gt; GetByEmailAsync(string email, CancellationToken cancellationToken)
    {
        try
        {
            var normalizedEmail = email.Trim().ToLowerInvariant();
            var user = await _context.Users
                .FirstOrDefaultAsync(u =&gt; u.Email == normalizedEmail, cancellationToken);

            if (user is null)
                return UserErrors.NotFound;

            return user;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.GetByEmail.DatabaseError&quot;, $&quot;Failed to retrieve user: {ex.Message}&quot;);
        }
    }

    public async Task&lt;ErrorOr&lt;bool&gt;&gt; ExistsByEmailAsync(string email, CancellationToken cancellationToken)
    {
        try
        {
            var normalizedEmail = email.Trim().ToLowerInvariant();
            var exists = await _context.Users
                .AsNoTracking()
                .AnyAsync(u =&gt; u.Email == normalizedEmail, cancellationToken);

            return exists;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.ExistsByEmail.DatabaseError&quot;, $&quot;Failed to check user existence: {ex.Message}&quot;);
        }
    }

    public async Task&lt;ErrorOr&lt;User&gt;&gt; CreateAsync(User user, CancellationToken cancellationToken)
    {
        try
        {
            _context.Users.Add(user);
            await _context.SaveChangesAsync(cancellationToken);

            return user;
        }
        catch (DbUpdateException ex) when (ex.InnerException?.Message.Contains(&quot;duplicate key&quot;) == true)
        {
            return UserErrors.DuplicateEmail;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.Create.DatabaseError&quot;, $&quot;Failed to create user: {ex.Message}&quot;);
        }
    }

    public async Task&lt;ErrorOr&lt;User&gt;&gt; UpdateAsync(User user, CancellationToken cancellationToken)
    {
        try
        {
            _context.Users.Update(user);
            await _context.SaveChangesAsync(cancellationToken);

            return user;
        }
        catch (DbUpdateConcurrencyException)
        {
            // This can happen if the user doesn&#39;t exist or was modified by another process
            // Check if user exists to provide appropriate error
            var exists = await _context.Users.AsNoTracking().AnyAsync(u =&gt; u.Id == user.Id, cancellationToken);
            return exists ? UserErrors.ConcurrencyError : UserErrors.NotFound;
        }
        catch (DbUpdateException ex) when (ex.InnerException?.Message.Contains(&quot;duplicate key&quot;) == true)
        {
            return UserErrors.DuplicateEmail;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.Update.DatabaseError&quot;, $&quot;Failed to update user: {ex.Message}&quot;);
        }
    }

    public async Task&lt;ErrorOr&lt;Deleted&gt;&gt; DeleteAsync(int id, CancellationToken cancellationToken)
    {
        try
        {
            var rowsAffected = await _context.Users
                .Where(u =&gt; u.Id == id)
                .ExecuteDeleteAsync(cancellationToken);

            if (rowsAffected == 0)
                return UserErrors.NotFound;

            return Result.Deleted;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;User.Delete.DatabaseError&quot;, $&quot;Failed to delete user: {ex.Message}&quot;);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,5,18,56,1],[19,5,19,6,1],[20,9,20,80,1],[21,5,21,6,1],[24,5,24,6,1],[26,9,26,10,1],[27,13,29,49,1],[31,13,31,26,1],[33,9,33,29,0],[34,9,34,10,0],[35,13,35,106,0],[37,5,37,6,1],[40,5,40,6,1],[42,9,42,10,1],[43,13,44,74,1],[46,13,46,30,1],[47,17,47,44,1],[49,13,49,25,1],[51,9,51,29,0],[52,9,52,10,0],[53,13,53,106,0],[55,5,55,6,1],[58,5,58,6,1],[60,9,60,10,1],[61,13,61,67,1],[62,13,63,90,1],[65,13,65,30,1],[66,17,66,44,1],[68,13,68,25,1],[70,9,70,29,0],[71,9,71,10,0],[72,13,72,109,0],[74,5,74,6,1],[77,5,77,6,1],[79,9,79,10,1],[80,13,80,67,1],[81,13,83,79,1],[85,13,85,27,1],[87,9,87,29,0],[88,9,88,10,0],[89,13,89,119,0],[91,5,91,6,1],[94,5,94,6,1],[96,9,96,10,1],[97,13,97,38,1],[98,13,98,64,1],[100,13,100,25,1],[102,38,102,105,1],[103,9,103,10,1],[104,13,104,46,1],[106,9,106,29,0],[107,9,107,10,0],[108,13,108,103,0],[110,5,110,6,1],[113,5,113,6,1],[115,9,115,10,1],[116,13,116,41,1],[117,13,117,64,1],[119,13,119,25,1],[121,9,121,45,1],[122,9,122,10,1],[125,13,125,112,1],[126,13,126,79,1],[128,38,128,105,0],[129,9,129,10,0],[130,13,130,46,0],[132,9,132,29,0],[133,9,133,10,0],[134,13,134,103,0],[136,5,136,6,1],[139,5,139,6,1],[141,9,141,10,1],[142,13,144,56,1],[146,13,146,35,1],[147,17,147,44,1],[149,13,149,35,1],[151,9,151,29,0],[152,9,152,10,0],[153,13,153,103,0],[155,5,155,6,1]]);
    </script>
  </body>
</html>