<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/tests/ExpenseTrackerAPI.Application.Tests/Categories/CategoryServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ErrorOr;
using ExpenseTrackerAPI.Application.Categories;
using ExpenseTrackerAPI.Application.Categories.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Domain.Entities;
using FluentAssertions;
using Moq;
using Xunit;

namespace ExpenseTrackerAPI.Application.Tests.Categories;

public class CategoryServiceTests
{
    private readonly Mock&lt;ICategoryRepository&gt; _mockCategoryRepository;
    private readonly CategoryService _categoryService;

    public CategoryServiceTests()
    {
        _mockCategoryRepository = new Mock&lt;ICategoryRepository&gt;();
        _categoryService = new CategoryService(_mockCategoryRepository.Object);
    }

    #region Constructor Tests

    [Fact]
    public void Constructor_WithNullCategoryRepository_ShouldThrowArgumentNullException()
    {
        // Act &amp; Assert
        var act = () =&gt; new CategoryService(null!);
        act.Should().Throw&lt;ArgumentNullException&gt;()
            .And.ParamName.Should().Be(&quot;categoryRepository&quot;);
    }

    #endregion

    #region GetAllAsync Tests

    [Fact]
    public async Task GetAllAsync_WhenRepositoryReturnsCategories_ShouldReturnCategories()
    {
        // Arrange
        var expectedCategories = new List&lt;Category&gt;
        {
            new Category { Id = 1, Name = &quot;Food &amp; Dining&quot;, Description = &quot;Restaurant and groceries&quot;, Icon = &quot;&#127828;&quot; },
            new Category { Id = 2, Name = &quot;Transportation&quot;, Description = &quot;Travel expenses&quot;, Icon = &quot;&#128663;&quot; },
            new Category { Id = 3, Name = &quot;Entertainment&quot;, Description = &quot;Fun and games&quot;, Icon = &quot;&#127916;&quot; }
        };

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(expectedCategories);

        // Act
        var result = await _categoryService.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Should().HaveCount(3);
        result.Value.Should().BeEquivalentTo(expectedCategories);

        _mockCategoryRepository.Verify(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()), Times.Once);
    }

    [Fact]
    public async Task GetAllAsync_WhenRepositoryReturnsEmptyList_ShouldReturnEmptyList()
    {
        // Arrange
        var emptyCategories = new List&lt;Category&gt;();

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(emptyCategories);

        // Act
        var result = await _categoryService.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Should().BeEmpty();

        _mockCategoryRepository.Verify(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()), Times.Once);
    }

    [Fact]
    public async Task GetAllAsync_WhenRepositoryReturnsError_ShouldReturnError()
    {
        // Arrange
        var expectedError = Error.Failure(&quot;Database.Error&quot;, &quot;Failed to retrieve categories&quot;);

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(expectedError);

        // Act
        var result = await _categoryService.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Should().Be(expectedError);

        _mockCategoryRepository.Verify(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()), Times.Once);
    }

    [Fact]
    public async Task GetAllAsync_ShouldPassCancellationToken()
    {
        // Arrange
        using var cts = new CancellationTokenSource();
        var token = cts.Token;

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(token))
            .ReturnsAsync(new List&lt;Category&gt;());

        // Act
        await _categoryService.GetAllAsync(token);

        // Assert
        _mockCategoryRepository.Verify(r =&gt; r.GetAllAsync(token), Times.Once);
    }

    [Fact]
    public async Task GetAllAsync_WhenCancelled_ShouldPropagateCancellation()
    {
        // Arrange
        using var cts = new CancellationTokenSource();
        cts.Cancel();

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ThrowsAsync(new OperationCanceledException());

        // Act &amp; Assert
        await Assert.ThrowsAsync&lt;OperationCanceledException&gt;(
            () =&gt; _categoryService.GetAllAsync(cts.Token));
    }

    [Fact]
    public async Task GetAllAsync_WhenRepositoryReturnsSingleCategory_ShouldReturnSingleCategory()
    {
        // Arrange
        var singleCategory = new List&lt;Category&gt;
        {
            new Category { Id = 1, Name = &quot;Salary&quot;, Description = &quot;Monthly income&quot;, Icon = &quot;&#128176;&quot; }
        };

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(singleCategory);

        // Act
        var result = await _categoryService.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().HaveCount(1);
        result.Value.First().Name.Should().Be(&quot;Salary&quot;);
        result.Value.First().Description.Should().Be(&quot;Monthly income&quot;);
        result.Value.First().Icon.Should().Be(&quot;&#128176;&quot;);
    }

    [Fact]
    public async Task GetAllAsync_WhenCategoryHasNullDescription_ShouldReturnCategoryWithNullDescription()
    {
        // Arrange
        var categoriesWithNullDescription = new List&lt;Category&gt;
        {
            new Category { Id = 1, Name = &quot;Miscellaneous&quot;, Description = null, Icon = &quot;&#128230;&quot; }
        };

        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(categoriesWithNullDescription);

        // Act
        var result = await _categoryService.GetAllAsync(CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().HaveCount(1);
        result.Value.First().Description.Should().BeNull();
    }

    [Fact]
    public async Task GetAllAsync_MultipleCalls_ShouldCallRepositoryEachTime()
    {
        // Arrange
        _mockCategoryRepository
            .Setup(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(new List&lt;Category&gt;());

        // Act
        await _categoryService.GetAllAsync(CancellationToken.None);
        await _categoryService.GetAllAsync(CancellationToken.None);
        await _categoryService.GetAllAsync(CancellationToken.None);

        // Assert
        _mockCategoryRepository.Verify(r =&gt; r.GetAllAsync(It.IsAny&lt;CancellationToken&gt;()), Times.Exactly(3));
    }

    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,5,16,34,1],[17,5,17,6,1],[18,9,18,67,1],[19,9,19,80,1],[20,5,20,6,1],[26,5,26,6,1],[28,9,28,25,1],[28,25,28,51,1],[28,51,28,52,1],[29,9,30,62,1],[31,5,31,6,1],[39,5,39,6,1],[41,9,46,11,1],[48,9,50,47,1],[53,9,53,81,1],[56,9,56,43,1],[57,9,57,43,1],[58,9,58,44,1],[59,9,59,66,1],[61,9,61,103,1],[62,5,62,6,1],[66,5,66,6,1],[68,9,68,52,1],[70,9,72,44,1],[75,9,75,81,1],[78,9,78,43,1],[79,9,79,43,1],[80,9,80,41,1],[82,9,82,103,1],[83,5,83,6,1],[87,5,87,6,1],[89,9,89,94,1],[91,9,93,42,1],[96,9,96,81,1],[99,9,99,42,1],[100,9,100,54,1],[102,9,102,103,1],[103,5,103,6,1],[107,5,107,6,1],[109,9,109,55,1],[110,9,110,31,1],[112,9,114,49,1],[117,9,117,51,1],[120,9,120,79,1],[121,5,121,6,1],[125,5,125,6,1],[127,9,127,55,1],[128,9,128,22,1],[130,9,132,60,1],[135,9,136,19,1],[136,19,136,58,1],[136,58,136,60,1],[137,5,137,6,1],[141,5,141,6,1],[143,9,146,11,1],[148,9,150,43,1],[153,9,153,81,1],[156,9,156,43,1],[157,9,157,44,1],[158,9,158,57,1],[159,9,159,72,1],[160,9,160,53,1],[161,5,161,6,1],[165,5,165,6,1],[167,9,170,11,1],[172,9,174,58,1],[177,9,177,81,1],[180,9,180,43,1],[181,9,181,44,1],[182,9,182,60,1],[183,5,183,6,1],[187,5,187,6,1],[189,9,191,49,1],[194,9,194,68,1],[195,9,195,68,1],[196,9,196,68,1],[199,9,199,109,1],[200,5,200,6,1]]);
    </script>
  </body>
</html>