<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/tests/ExpenseTrackerAPI.Application.Tests/Transactions/TransactionServiceFilteringTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ErrorOr;
using ExpenseTrackerAPI.Application.Transactions;
using ExpenseTrackerAPI.Application.Transactions.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Application.Users.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Contracts.Transactions;
using ExpenseTrackerAPI.Domain.Entities;
using ExpenseTrackerAPI.Domain.Errors;
using FluentAssertions;
using Moq;
using Xunit;

namespace ExpenseTrackerAPI.Application.Tests.Transactions;

/// &lt;summary&gt;
/// Application layer tests for TransactionService filtering functionality.
/// Tests the GetByUserIdWithFilterAsync method which coordinates between repositories
/// and transforms domain entities to response DTOs.
/// &lt;/summary&gt;
public class TransactionServiceFilteringTests
{
    private readonly Mock&lt;ITransactionRepository&gt; _transactionRepositoryMock;
    private readonly Mock&lt;IUserRepository&gt; _userRepositoryMock;
    private readonly TransactionService _sut;

    public TransactionServiceFilteringTests()
    {
        _transactionRepositoryMock = new Mock&lt;ITransactionRepository&gt;();
        _userRepositoryMock = new Mock&lt;IUserRepository&gt;();
        _sut = new TransactionService(_transactionRepositoryMock.Object, _userRepositoryMock.Object);
    }

    #region Helper Methods

    private static User CreateTestUser(int id = 1)
    {
        return new User(
            name: &quot;Test User&quot;,
            email: &quot;test@example.com&quot;,
            passwordHash: &quot;hashed_password&quot;,
            initialBalance: 1000m
        );
    }

    private static Transaction CreateTestTransaction(
        int id,
        int userId,
        TransactionType type,
        decimal amount,
        DateOnly date,
        string subject)
    {
        var transaction = new Transaction(
            userId: userId,
            transactionType: type,
            amount: amount,
            date: date,
            subject: subject,
            paymentMethod: PaymentMethod.CASH,
            notes: null,
            categoryId: null,
            transactionGroupId: null,
            createdAt: DateTime.UtcNow,
            updatedAt: DateTime.UtcNow
        );
        transaction.UpdateId(id);
        return transaction;
    }

    #endregion

    [Fact]
    public async Task GetByUserIdWithFilterAsync_UserExists_ReturnsFilteredTransactionsAsResponse()
    {
        // Arrange
        const int userId = 1;
        var user = CreateTestUser(userId);
        var filter = new TransactionFilter
        {
            TransactionType = TransactionType.EXPENSE,
            Page = 1,
            PageSize = 20
        };

        var transactions = new List&lt;Transaction&gt;
        {
            CreateTestTransaction(1, userId, TransactionType.EXPENSE, 50m, new DateOnly(2024, 1, 1), &quot;Expense 1&quot;),
            CreateTestTransaction(2, userId, TransactionType.EXPENSE, 75m, new DateOnly(2024, 1, 2), &quot;Expense 2&quot;)
        };

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(user);

        _transactionRepositoryMock
            .Setup(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(transactions);

        // Act
        var result = await _sut.GetByUserIdWithFilterAsync(userId, filter, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Transactions.Should().HaveCount(2);
        result.Value.Transactions[0].Subject.Should().Be(&quot;Expense 1&quot;);
        result.Value.Transactions[1].Subject.Should().Be(&quot;Expense 2&quot;);

        // Verify repository interactions
        _userRepositoryMock.Verify(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()), Times.Once);
        _transactionRepositoryMock.Verify(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()), Times.Once);
    }

    [Fact]
    public async Task GetByUserIdWithFilterAsync_UserDoesNotExist_ReturnsUserNotFoundError()
    {
        // Arrange
        const int userId = 999;
        var filter = new TransactionFilter
        {
            Page = 1,
            PageSize = 20
        };

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(UserErrors.NotFound);

        // Act
        var result = await _sut.GetByUserIdWithFilterAsync(userId, filter, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Should().Be(UserErrors.NotFound);

        // Verify user repository was called but transaction repository was not
        _userRepositoryMock.Verify(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()), Times.Once);
        _transactionRepositoryMock.Verify(x =&gt; x.GetByUserIdWithFilterAsync(It.IsAny&lt;int&gt;(), It.IsAny&lt;TransactionFilter&gt;(), It.IsAny&lt;CancellationToken&gt;()), Times.Never);
    }

    [Fact]
    public async Task GetByUserIdWithFilterAsync_RepositoryReturnsError_PropagatesError()
    {
        // Arrange
        const int userId = 1;
        var user = CreateTestUser(userId);
        var filter = new TransactionFilter { Page = 1, PageSize = 20 };

        var databaseError = Error.Failure(&quot;Database.Error&quot;, &quot;Failed to retrieve transactions&quot;);

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(user);

        _transactionRepositoryMock
            .Setup(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(databaseError);

        // Act
        var result = await _sut.GetByUserIdWithFilterAsync(userId, filter, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Should().Be(databaseError);
    }

    [Fact]
    public async Task GetByUserIdWithFilterAsync_NoMatchingTransactions_ReturnsEmptyList()
    {
        // Arrange
        const int userId = 1;
        var user = CreateTestUser(userId);
        var filter = new TransactionFilter
        {
            TransactionType = TransactionType.INCOME,
            Page = 1,
            PageSize = 20
        };

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(user);

        _transactionRepositoryMock
            .Setup(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(new List&lt;Transaction&gt;());

        // Act
        var result = await _sut.GetByUserIdWithFilterAsync(userId, filter, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Transactions.Should().BeEmpty();
    }

    [Fact]
    public async Task GetByUserIdWithFilterAsync_ComplexFilter_PassesFilterToRepository()
    {
        // Arrange
        const int userId = 1;
        var user = CreateTestUser(userId);
        var filter = new TransactionFilter
        {
            TransactionType = TransactionType.EXPENSE,
            MinAmount = 50m,
            MaxAmount = 200m,
            DateFrom = new DateOnly(2024, 1, 1),
            DateTo = new DateOnly(2024, 12, 31),
            SubjectContains = &quot;coffee&quot;,
            PaymentMethods = new List&lt;PaymentMethod&gt; { PaymentMethod.CASH, PaymentMethod.DEBIT_CARD },
            CategoryIds = new List&lt;int&gt; { 1, 2 },
            SortBy = TransactionSortField.Amount,
            SortDescending = true,
            Page = 2,
            PageSize = 10
        };

        var transactions = new List&lt;Transaction&gt;
        {
            CreateTestTransaction(1, userId, TransactionType.EXPENSE, 100m, new DateOnly(2024, 6, 15), &quot;Coffee shop&quot;)
        };

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(user);

        _transactionRepositoryMock
            .Setup(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(transactions);

        // Act
        var result = await _sut.GetByUserIdWithFilterAsync(userId, filter, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Transactions.Should().HaveCount(1);

        // Verify the exact filter was passed to repository
        _transactionRepositoryMock.Verify(x =&gt; x.GetByUserIdWithFilterAsync(
            It.Is&lt;int&gt;(id =&gt; id == userId),
            It.Is&lt;TransactionFilter&gt;(f =&gt;
                f.TransactionType == TransactionType.EXPENSE &amp;&amp;
                f.MinAmount == 50m &amp;&amp;
                f.MaxAmount == 200m &amp;&amp;
                f.DateFrom == new DateOnly(2024, 1, 1) &amp;&amp;
                f.DateTo == new DateOnly(2024, 12, 31) &amp;&amp;
                f.SubjectContains == &quot;coffee&quot; &amp;&amp;
                f.SortBy == TransactionSortField.Amount &amp;&amp;
                f.SortDescending == true &amp;&amp;
                f.Page == 2 &amp;&amp;
                f.PageSize == 10),
            It.IsAny&lt;CancellationToken&gt;()), Times.Once);
    }

    [Fact]
    public async Task GetByUserIdWithFilterAsync_TransactionsReturned_MapsAllFieldsToResponse()
    {
        // Arrange
        const int userId = 1;
        var user = CreateTestUser(userId);
        var filter = new TransactionFilter { Page = 1, PageSize = 20 };

        var transaction = new Transaction(
            userId: userId,
            transactionType: TransactionType.EXPENSE,
            amount: 150.50m,
            date: new DateOnly(2024, 3, 15),
            subject: &quot;Grocery Shopping&quot;,
            paymentMethod: PaymentMethod.CREDIT_CARD,
            notes: &quot;Weekly groceries&quot;,
            categoryId: 5,
            transactionGroupId: 10,
            createdAt: new DateTime(2024, 3, 15, 10, 30, 0, DateTimeKind.Utc),
            updatedAt: new DateTime(2024, 3, 15, 10, 30, 0, DateTimeKind.Utc)
        );
        transaction.UpdateId(42);

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(user);

        _transactionRepositoryMock
            .Setup(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(new List&lt;Transaction&gt; { transaction });

        // Act
        var result = await _sut.GetByUserIdWithFilterAsync(userId, filter, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        var responseTransaction = result.Value.Transactions.Should().ContainSingle().Subject;

        responseTransaction.Id.Should().Be(42);
        responseTransaction.UserId.Should().Be(userId);
        responseTransaction.TransactionType.Should().Be(&quot;EXPENSE&quot;);
        responseTransaction.Amount.Should().Be(150.50m);
        responseTransaction.Date.Should().Be(new DateOnly(2024, 3, 15));
        responseTransaction.Subject.Should().Be(&quot;Grocery Shopping&quot;);
        responseTransaction.PaymentMethod.Should().Be(&quot;CREDIT_CARD&quot;);
        responseTransaction.Notes.Should().Be(&quot;Weekly groceries&quot;);
        responseTransaction.CategoryId.Should().Be(5);
        responseTransaction.TransactionGroupId.Should().Be(10);
    }

    [Fact]
    public async Task GetByUserIdWithFilterAsync_CancellationRequested_PropagatesCancellationToken()
    {
        // Arrange
        const int userId = 1;
        var user = CreateTestUser(userId);
        var filter = new TransactionFilter { Page = 1, PageSize = 20 };
        var cts = new CancellationTokenSource();
        cts.Cancel();

        _userRepositoryMock
            .Setup(x =&gt; x.GetByIdAsync(userId, It.IsAny&lt;CancellationToken&gt;()))
            .ReturnsAsync(user);

        _transactionRepositoryMock
            .Setup(x =&gt; x.GetByUserIdWithFilterAsync(userId, filter, It.IsAny&lt;CancellationToken&gt;()))
            .ThrowsAsync(new OperationCanceledException());

        // Act &amp; Assert
        await Assert.ThrowsAsync&lt;OperationCanceledException&gt;(
            async () =&gt; await _sut.GetByUserIdWithFilterAsync(userId, filter, cts.Token));
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,5,25,46,1],[26,5,26,6,1],[27,9,27,73,1],[28,9,28,59,1],[29,9,29,102,1],[30,5,30,6,1],[35,5,35,6,1],[36,9,41,11,1],[42,5,42,6,1],[51,5,51,6,1],[52,9,64,11,1],[65,9,65,34,1],[66,9,66,28,1],[67,5,67,6,1],[73,5,73,6,1],[76,9,76,43,1],[77,9,82,11,1],[84,9,88,11,1],[90,9,92,33,1],[94,9,96,41,1],[99,9,99,100,1],[102,9,102,43,1],[103,9,103,43,1],[104,9,104,57,1],[105,9,105,71,1],[106,9,106,71,1],[109,9,109,108,1],[110,9,110,137,1],[111,5,111,6,1],[115,5,115,6,1],[118,9,122,11,1],[124,9,126,48,1],[129,9,129,100,1],[132,9,132,42,1],[133,9,133,60,1],[136,9,136,108,1],[137,9,137,170,1],[138,5,138,6,1],[142,5,142,6,1],[145,9,145,43,1],[146,9,146,72,1],[148,9,148,96,1],[150,9,152,33,1],[154,9,156,42,1],[159,9,159,100,1],[162,9,162,42,1],[163,9,163,54,1],[164,5,164,6,1],[168,5,168,6,1],[171,9,171,43,1],[172,9,177,11,1],[179,9,181,33,1],[183,9,185,52,1],[188,9,188,100,1],[191,9,191,43,1],[192,9,192,43,1],[193,9,193,54,1],[194,5,194,6,1],[198,5,198,6,1],[201,9,201,43,1],[202,9,216,11,1],[218,9,221,11,1],[223,9,225,33,1],[227,9,229,41,1],[232,9,232,100,1],[235,9,235,43,1],[236,9,236,57,1],[239,9,252,57,1],[253,5,253,6,1],[257,5,257,6,1],[260,9,260,43,1],[261,9,261,72,1],[263,9,275,11,1],[276,9,276,34,1],[278,9,280,33,1],[282,9,284,66,1],[287,9,287,100,1],[290,9,290,43,1],[291,9,291,94,1],[293,9,293,48,1],[294,9,294,56,1],[295,9,295,68,1],[296,9,296,57,1],[297,9,297,73,1],[298,9,298,69,1],[299,9,299,70,1],[300,9,300,67,1],[301,9,301,55,1],[302,9,302,64,1],[303,5,303,6,1],[307,5,307,6,1],[310,9,310,43,1],[311,9,311,72,1],[312,9,312,49,1],[313,9,313,22,1],[315,9,317,33,1],[319,9,321,60,1],[324,9,325,25,1],[325,25,325,89,1],[325,89,325,91,1],[326,5,326,6,1]]);
    </script>
  </body>
</html>