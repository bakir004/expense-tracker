<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/src/ExpenseTrackerAPI.Infrastructure/TransactionGroups/TransactionGroupRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ErrorOr;
using Microsoft.EntityFrameworkCore;
using ExpenseTrackerAPI.Application.TransactionGroups.Interfaces.Infrastructure;
using ExpenseTrackerAPI.Domain.Entities;
using ExpenseTrackerAPI.Domain.Errors;
using ExpenseTrackerAPI.Infrastructure.Persistence;

namespace ExpenseTrackerAPI.Infrastructure.TransactionGroups;

/// &lt;summary&gt;
/// EF Core implementation of the transaction group repository.
/// &lt;/summary&gt;
public class TransactionGroupRepository : ITransactionGroupRepository
{
    private readonly ApplicationDbContext _context;

    public TransactionGroupRepository(ApplicationDbContext context)
    {
        _context = context ?? throw new ArgumentNullException(nameof(context));
    }

    /// &lt;inheritdoc /&gt;
    public async Task&lt;ErrorOr&lt;TransactionGroup&gt;&gt; GetByIdAsync(int id, CancellationToken cancellationToken)
    {
        try
        {
            var transactionGroup = await _context.TransactionGroups
                .AsNoTracking()
                .FirstOrDefaultAsync(g =&gt; g.Id == id, cancellationToken);

            if (transactionGroup == null)
            {
                return TransactionGroupErrors.NotFound;
            }

            return transactionGroup;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;Database.Error&quot;, $&quot;Failed to retrieve transaction group: {ex.Message}&quot;);
        }
    }

    /// &lt;inheritdoc /&gt;
    public async Task&lt;ErrorOr&lt;List&lt;TransactionGroup&gt;&gt;&gt; GetByUserIdAsync(int userId, CancellationToken cancellationToken)
    {
        try
        {
            var transactionGroups = await _context.TransactionGroups
                .AsNoTracking()
                .Where(g =&gt; g.UserId == userId)
                .OrderBy(g =&gt; g.Name)
                .ToListAsync(cancellationToken);

            return transactionGroups;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;Database.Error&quot;, $&quot;Failed to retrieve transaction groups: {ex.Message}&quot;);
        }
    }

    /// &lt;inheritdoc /&gt;
    public async Task&lt;ErrorOr&lt;TransactionGroup&gt;&gt; CreateAsync(TransactionGroup transactionGroup, CancellationToken cancellationToken)
    {
        try
        {
            _context.TransactionGroups.Add(transactionGroup);
            await _context.SaveChangesAsync(cancellationToken);

            return transactionGroup;
        }
        catch (DbUpdateException ex)
        {
            // Check for foreign key violation (user doesn&#39;t exist)
            if (ex.InnerException?.Message.Contains(&quot;user&quot;, StringComparison.OrdinalIgnoreCase) == true ||
                ex.InnerException?.Message.Contains(&quot;foreign key&quot;, StringComparison.OrdinalIgnoreCase) == true)
            {
                return TransactionGroupErrors.UserNotFound;
            }

            return Error.Failure(&quot;Database.Error&quot;, $&quot;Failed to create transaction group: {ex.Message}&quot;);
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;Database.Error&quot;, $&quot;Failed to create transaction group: {ex.Message}&quot;);
        }
    }

    /// &lt;inheritdoc /&gt;
    public async Task&lt;ErrorOr&lt;TransactionGroup&gt;&gt; UpdateAsync(TransactionGroup transactionGroup, CancellationToken cancellationToken)
    {
        try
        {
            _context.TransactionGroups.Update(transactionGroup);
            await _context.SaveChangesAsync(cancellationToken);

            return transactionGroup;
        }
        catch (DbUpdateConcurrencyException)
        {
            return TransactionGroupErrors.NotFound;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;Database.Error&quot;, $&quot;Failed to update transaction group: {ex.Message}&quot;);
        }
    }

    /// &lt;inheritdoc /&gt;
    public async Task&lt;ErrorOr&lt;Deleted&gt;&gt; DeleteAsync(int id, CancellationToken cancellationToken)
    {
        try
        {
            var deletedCount = await _context.TransactionGroups
                .Where(g =&gt; g.Id == id)
                .ExecuteDeleteAsync(cancellationToken);

            if (deletedCount == 0)
            {
                return TransactionGroupErrors.NotFound;
            }

            return Result.Deleted;
        }
        catch (Exception ex)
        {
            return Error.Failure(&quot;Database.Error&quot;, $&quot;Failed to delete transaction group: {ex.Message}&quot;);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,5,17,68,1],[18,5,18,6,1],[19,9,19,80,1],[20,5,20,6,1],[24,5,24,6,1],[26,9,26,10,1],[27,13,29,74,1],[31,13,31,42,1],[32,13,32,14,1],[33,17,33,56,1],[36,13,36,37,1],[38,9,38,29,0],[39,9,39,10,0],[40,13,40,107,0],[42,5,42,6,1],[46,5,46,6,1],[48,9,48,10,1],[49,13,53,49,1],[55,13,55,38,1],[57,9,57,29,0],[58,9,58,10,0],[59,13,59,108,0],[61,5,61,6,1],[65,5,65,6,1],[67,9,67,10,1],[68,13,68,62,1],[69,13,69,64,1],[71,13,71,37,1],[73,9,73,37,1],[74,9,74,10,1],[76,13,77,112,1],[78,13,78,14,1],[79,17,79,60,1],[82,13,82,105,0],[84,9,84,29,0],[85,9,85,10,0],[86,13,86,105,0],[88,5,88,6,1],[92,5,92,6,1],[94,9,94,10,1],[95,13,95,65,1],[96,13,96,64,1],[98,13,98,37,1],[100,9,100,45,1],[101,9,101,10,1],[102,13,102,52,1],[104,9,104,29,0],[105,9,105,10,0],[106,13,106,105,0],[108,5,108,6,1],[112,5,112,6,1],[114,9,114,10,1],[115,13,117,56,1],[119,13,119,35,1],[120,13,120,14,1],[121,17,121,56,1],[124,13,124,35,1],[126,9,126,29,0],[127,9,127,10,0],[128,13,128,105,0],[130,5,130,6,1]]);
    </script>
  </body>
</html>