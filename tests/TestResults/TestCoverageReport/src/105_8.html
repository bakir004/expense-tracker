<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/bax/Desktop/kodecta-academy/expense-tracker/tests/ExpenseTrackerAPI.Infrastructure.Tests/Repositories/TransactionGroupRepositoryTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ExpenseTrackerAPI.Domain.Entities;
using ExpenseTrackerAPI.Infrastructure.Tests.Fixtures;
using ExpenseTrackerAPI.Infrastructure.TransactionGroups;
using ExpenseTrackerAPI.Infrastructure.Users;
using FluentAssertions;
using Microsoft.EntityFrameworkCore;

namespace ExpenseTrackerAPI.Infrastructure.Tests.Repositories;

[Collection(nameof(DatabaseCollection))]
public class TransactionGroupRepositoryTests
{
    private readonly DatabaseFixture _fixture;

    public TransactionGroupRepositoryTests(DatabaseFixture fixture)
    {
        _fixture = fixture;
    }

    private async Task&lt;User&gt; CreateTestUserAsync(string? email = null)
    {
        var userRepo = new UserRepository(_fixture.DbContext);
        var user = new User(
            name: &quot;Test User&quot;,
            email: email ?? $&quot;test-{Guid.NewGuid():N}@integration.test&quot;,
            passwordHash: &quot;hashed_password&quot;,
            initialBalance: 0
        );
        var result = await userRepo.CreateAsync(user, CancellationToken.None);
        Assert.False(result.IsError);
        return result.Value;
    }

    private TransactionGroup CreateTransactionGroup(int userId, string name, string? description = null)
    {
        return new TransactionGroup
        {
            Name = name,
            Description = description,
            UserId = userId,
            CreatedAt = DateTime.UtcNow
        };
    }

    #region GetByIdAsync Tests

    [Fact]
    public async Task GetByIdAsync_ExistingGroup_ReturnsGroup()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Vacation Trip&quot;, &quot;Summer vacation expenses&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.GetByIdAsync(groupId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Id.Should().Be(groupId);
        result.Value.Name.Should().Be(&quot;Vacation Trip&quot;);
        result.Value.Description.Should().Be(&quot;Summer vacation expenses&quot;);
        result.Value.UserId.Should().Be(user.Id);
    }

    [Fact]
    public async Task GetByIdAsync_NonExistentGroup_ReturnsNotFoundError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);

        // Act
        var result = await sut.GetByIdAsync(99999, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;TransactionGroup&quot;);
        result.FirstError.Type.Should().Be(ErrorOr.ErrorType.NotFound);
    }

    [Fact]
    public async Task GetByIdAsync_DoesNotTrackEntities()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Test Group&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.GetByIdAsync(groupId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        var trackedEntities = _fixture.DbContext.ChangeTracker.Entries&lt;TransactionGroup&gt;().Count();
        trackedEntities.Should().Be(0);
    }

    #endregion

    #region GetByUserIdAsync Tests

    [Fact]
    public async Task GetByUserIdAsync_ExistingUserWithGroups_ReturnsGroups()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        _fixture.DbContext.TransactionGroups.AddRange(
            CreateTransactionGroup(user.Id, &quot;Group A&quot;),
            CreateTransactionGroup(user.Id, &quot;Group B&quot;),
            CreateTransactionGroup(user.Id, &quot;Group C&quot;)
        );
        await _fixture.DbContext.SaveChangesAsync();
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.GetByUserIdAsync(user.Id, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().HaveCount(3);
    }

    [Fact]
    public async Task GetByUserIdAsync_UserWithNoGroups_ReturnsEmptyList()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        // Act
        var result = await sut.GetByUserIdAsync(user.Id, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Should().BeEmpty();
    }

    [Fact]
    public async Task GetByUserIdAsync_ReturnsGroupsSortedByName()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        // Add groups in non-alphabetical order
        _fixture.DbContext.TransactionGroups.AddRange(
            CreateTransactionGroup(user.Id, &quot;Zebra Project&quot;),
            CreateTransactionGroup(user.Id, &quot;Alpha Project&quot;),
            CreateTransactionGroup(user.Id, &quot;Mango Budget&quot;)
        );
        await _fixture.DbContext.SaveChangesAsync();
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.GetByUserIdAsync(user.Id, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().HaveCount(3);
        result.Value[0].Name.Should().Be(&quot;Alpha Project&quot;);
        result.Value[1].Name.Should().Be(&quot;Mango Budget&quot;);
        result.Value[2].Name.Should().Be(&quot;Zebra Project&quot;);
    }

    [Fact]
    public async Task GetByUserIdAsync_ReturnsOnlyUserGroups_NotOtherUsersGroups()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user1 = await CreateTestUserAsync();
        var user2 = await CreateTestUserAsync();

        _fixture.DbContext.TransactionGroups.AddRange(
            CreateTransactionGroup(user1.Id, &quot;User1 Group A&quot;),
            CreateTransactionGroup(user1.Id, &quot;User1 Group B&quot;),
            CreateTransactionGroup(user2.Id, &quot;User2 Group A&quot;)
        );
        await _fixture.DbContext.SaveChangesAsync();
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.GetByUserIdAsync(user1.Id, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().HaveCount(2);
        result.Value.Should().OnlyContain(g =&gt; g.UserId == user1.Id);
    }

    [Fact]
    public async Task GetByUserIdAsync_NonExistentUser_ReturnsEmptyList()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);

        // Act
        var result = await sut.GetByUserIdAsync(99999, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().BeEmpty();
    }

    #endregion

    #region CreateAsync Tests

    [Fact]
    public async Task CreateAsync_ValidGroup_CreatesAndReturnsGroupWithId()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;New Project&quot;, &quot;Project description&quot;);

        // Act
        var result = await sut.CreateAsync(group, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().NotBeNull();
        result.Value.Id.Should().BeGreaterThan(0);
        result.Value.Name.Should().Be(&quot;New Project&quot;);
        result.Value.Description.Should().Be(&quot;Project description&quot;);
        result.Value.UserId.Should().Be(user.Id);
    }

    [Fact]
    public async Task CreateAsync_ValidGroup_PersistsToDatabase()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Persistent Group&quot;);

        // Act
        var createResult = await sut.CreateAsync(group, CancellationToken.None);
        var groupId = createResult.Value.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Verify by fetching from database
        var fetchResult = await sut.GetByIdAsync(groupId, CancellationToken.None);

        // Assert
        fetchResult.IsError.Should().BeFalse();
        fetchResult.Value.Name.Should().Be(&quot;Persistent Group&quot;);
    }

    [Fact]
    public async Task CreateAsync_MultipleGroups_AssignsUniqueIds()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group1 = CreateTransactionGroup(user.Id, &quot;Group 1&quot;);
        var group2 = CreateTransactionGroup(user.Id, &quot;Group 2&quot;);
        var group3 = CreateTransactionGroup(user.Id, &quot;Group 3&quot;);

        // Act
        var result1 = await sut.CreateAsync(group1, CancellationToken.None);
        var result2 = await sut.CreateAsync(group2, CancellationToken.None);
        var result3 = await sut.CreateAsync(group3, CancellationToken.None);

        // Assert
        result1.IsError.Should().BeFalse();
        result2.IsError.Should().BeFalse();
        result3.IsError.Should().BeFalse();

        var ids = new[] { result1.Value.Id, result2.Value.Id, result3.Value.Id };
        ids.Should().OnlyHaveUniqueItems();
    }

    [Fact]
    public async Task CreateAsync_WithNullDescription_CreatesGroupSuccessfully()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;No Description Group&quot;, null);

        // Act
        var result = await sut.CreateAsync(group, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Description.Should().BeNull();
    }

    [Fact]
    public async Task CreateAsync_WithNonExistentUser_ReturnsError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);

        var group = CreateTransactionGroup(99999, &quot;Orphan Group&quot;);

        // Act
        var result = await sut.CreateAsync(group, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
    }

    #endregion

    #region UpdateAsync Tests

    [Fact]
    public async Task UpdateAsync_ExistingGroup_UpdatesAndReturnsGroup()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Original Name&quot;, &quot;Original Description&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;

        // Detach the entity so we can update it
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var existingGroup = await _fixture.DbContext.TransactionGroups.FirstAsync(g =&gt; g.Id == groupId);
        existingGroup.Name = &quot;Updated Name&quot;;
        existingGroup.Description = &quot;Updated Description&quot;;

        var result = await sut.UpdateAsync(existingGroup, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Name.Should().Be(&quot;Updated Name&quot;);
        result.Value.Description.Should().Be(&quot;Updated Description&quot;);
    }

    [Fact]
    public async Task UpdateAsync_ExistingGroup_PersistsChangesToDatabase()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Original Name&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Update the group
        var existingGroup = await _fixture.DbContext.TransactionGroups.FirstAsync(g =&gt; g.Id == groupId);
        existingGroup.Name = &quot;Persisted Update&quot;;
        await sut.UpdateAsync(existingGroup, CancellationToken.None);
        _fixture.DbContext.ChangeTracker.Clear();

        // Act - Fetch fresh from database
        var fetchResult = await sut.GetByIdAsync(groupId, CancellationToken.None);

        // Assert
        fetchResult.IsError.Should().BeFalse();
        fetchResult.Value.Name.Should().Be(&quot;Persisted Update&quot;);
    }

    [Fact]
    public async Task UpdateAsync_CanSetDescriptionToNull()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Group With Description&quot;, &quot;Has Description&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var existingGroup = await _fixture.DbContext.TransactionGroups.FirstAsync(g =&gt; g.Id == groupId);
        existingGroup.Description = null;
        var result = await sut.UpdateAsync(existingGroup, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Description.Should().BeNull();
    }

    #endregion

    #region DeleteAsync Tests

    [Fact]
    public async Task DeleteAsync_ExistingGroup_DeletesAndReturnsDeleted()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;To Be Deleted&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.DeleteAsync(groupId, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
    }

    [Fact]
    public async Task DeleteAsync_ExistingGroup_RemovesFromDatabase()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Will Be Gone&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        await sut.DeleteAsync(groupId, CancellationToken.None);
        _fixture.DbContext.ChangeTracker.Clear();

        // Verify by trying to fetch
        var fetchResult = await sut.GetByIdAsync(groupId, CancellationToken.None);

        // Assert
        fetchResult.IsError.Should().BeTrue();
        fetchResult.FirstError.Type.Should().Be(ErrorOr.ErrorType.NotFound);
    }

    [Fact]
    public async Task DeleteAsync_NonExistentGroup_ReturnsNotFoundError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);

        // Act
        var result = await sut.DeleteAsync(99999, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Type.Should().Be(ErrorOr.ErrorType.NotFound);
    }

    [Fact]
    public async Task DeleteAsync_OnlyDeletesSpecifiedGroup()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group1 = CreateTransactionGroup(user.Id, &quot;Group 1&quot;);
        var group2 = CreateTransactionGroup(user.Id, &quot;Group 2&quot;);
        var group3 = CreateTransactionGroup(user.Id, &quot;Group 3&quot;);

        _fixture.DbContext.TransactionGroups.AddRange(group1, group2, group3);
        await _fixture.DbContext.SaveChangesAsync();

        var groupToDeleteId = group2.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        await sut.DeleteAsync(groupToDeleteId, CancellationToken.None);
        _fixture.DbContext.ChangeTracker.Clear();

        // Verify remaining groups
        var remainingGroups = await sut.GetByUserIdAsync(user.Id, CancellationToken.None);

        // Assert
        remainingGroups.IsError.Should().BeFalse();
        remainingGroups.Value.Should().HaveCount(2);
        remainingGroups.Value.Should().NotContain(g =&gt; g.Id == groupToDeleteId);
    }

    #endregion

    #region Additional Edge Case Tests

    [Fact]
    public async Task GetByUserIdAsync_DoesNotTrackEntities()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;Test Group&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var result = await sut.GetByUserIdAsync(user.Id, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();

        // Verify entities are not tracked (AsNoTracking was used)
        var trackedEntities = _fixture.DbContext.ChangeTracker.Entries&lt;TransactionGroup&gt;().Count();
        trackedEntities.Should().Be(0);
    }

    [Fact]
    public async Task UpdateAsync_NonExistentGroup_ReturnsNotFoundError()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        // Create and then delete a group to simulate updating a non-existent group
        var group = CreateTransactionGroup(user.Id, &quot;Temporary Group&quot;);
        _fixture.DbContext.TransactionGroups.Add(group);
        await _fixture.DbContext.SaveChangesAsync();
        var groupId = group.Id;

        // Delete the group
        await sut.DeleteAsync(groupId, CancellationToken.None);
        _fixture.DbContext.ChangeTracker.Clear();

        // Try to update the deleted group
        group.Name = &quot;Updated Name&quot;;

        // Act
        var result = await sut.UpdateAsync(group, CancellationToken.None);

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Be(&quot;TransactionGroup&quot;);
    }

    [Fact]
    public async Task CreateAsync_WithEmptyName_CreatesSuccessfully()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        var group = CreateTransactionGroup(user.Id, &quot;&quot;);

        // Act
        var result = await sut.CreateAsync(group, CancellationToken.None);

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Name.Should().Be(&quot;&quot;);
        result.Value.Id.Should().BeGreaterThan(0);
    }

    #endregion

    #region Integration / Interaction Tests

    [Fact]
    public async Task CreateUpdateDelete_FullLifecycle_WorksCorrectly()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);
        var user = await CreateTestUserAsync();

        // Create
        var group = CreateTransactionGroup(user.Id, &quot;Lifecycle Test&quot;, &quot;Initial Description&quot;);
        var createResult = await sut.CreateAsync(group, CancellationToken.None);
        createResult.IsError.Should().BeFalse();
        var groupId = createResult.Value.Id;
        _fixture.DbContext.ChangeTracker.Clear();

        // Update
        var toUpdate = await _fixture.DbContext.TransactionGroups.FirstAsync(g =&gt; g.Id == groupId);
        toUpdate.Name = &quot;Updated Lifecycle Test&quot;;
        toUpdate.Description = &quot;Updated Description&quot;;
        var updateResult = await sut.UpdateAsync(toUpdate, CancellationToken.None);
        updateResult.IsError.Should().BeFalse();
        _fixture.DbContext.ChangeTracker.Clear();

        // Verify update
        var verifyResult = await sut.GetByIdAsync(groupId, CancellationToken.None);
        verifyResult.IsError.Should().BeFalse();
        verifyResult.Value.Name.Should().Be(&quot;Updated Lifecycle Test&quot;);
        verifyResult.Value.Description.Should().Be(&quot;Updated Description&quot;);

        // Delete
        var deleteResult = await sut.DeleteAsync(groupId, CancellationToken.None);
        deleteResult.IsError.Should().BeFalse();
        _fixture.DbContext.ChangeTracker.Clear();

        // Verify deletion
        var finalResult = await sut.GetByIdAsync(groupId, CancellationToken.None);
        finalResult.IsError.Should().BeTrue();
    }

    [Fact]
    public async Task MultipleUsers_IndependentTransactionGroups()
    {
        // Arrange
        await _fixture.ResetDatabaseAsync();
        var sut = new TransactionGroupRepository(_fixture.DbContext);

        var user1 = await CreateTestUserAsync();
        var user2 = await CreateTestUserAsync();

        // Create groups for both users
        await sut.CreateAsync(CreateTransactionGroup(user1.Id, &quot;User1 Project&quot;), CancellationToken.None);
        await sut.CreateAsync(CreateTransactionGroup(user2.Id, &quot;User2 Project A&quot;), CancellationToken.None);
        await sut.CreateAsync(CreateTransactionGroup(user2.Id, &quot;User2 Project B&quot;), CancellationToken.None);
        _fixture.DbContext.ChangeTracker.Clear();

        // Act
        var user1Groups = await sut.GetByUserIdAsync(user1.Id, CancellationToken.None);
        var user2Groups = await sut.GetByUserIdAsync(user2.Id, CancellationToken.None);

        // Assert
        user1Groups.IsError.Should().BeFalse();
        user2Groups.IsError.Should().BeFalse();

        user1Groups.Value.Should().HaveCount(1);
        user2Groups.Value.Should().HaveCount(2);

        user1Groups.Value.Should().OnlyContain(g =&gt; g.UserId == user1.Id);
        user2Groups.Value.Should().OnlyContain(g =&gt; g.UserId == user2.Id);
    }

    #endregion
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[15,5,15,68,1],[16,5,16,6,1],[17,9,17,28,1],[18,5,18,6,1],[21,5,21,6,1],[22,9,22,63,1],[23,9,28,11,1],[29,9,29,79,1],[30,9,30,38,1],[31,9,31,29,1],[32,5,32,6,1],[35,5,35,6,1],[36,9,42,11,1],[43,5,43,6,1],[49,5,49,6,1],[51,9,51,45,1],[52,9,52,70,1],[53,9,53,48,1],[55,9,55,98,1],[56,9,56,57,1],[57,9,57,53,1],[58,9,58,32,1],[59,9,59,50,1],[62,9,62,78,1],[65,9,65,43,1],[66,9,66,43,1],[67,9,67,46,1],[68,9,68,56,1],[69,9,69,74,1],[70,9,70,50,1],[71,5,71,6,1],[75,5,75,6,1],[77,9,77,45,1],[78,9,78,70,1],[81,9,81,76,1],[84,9,84,42,1],[85,9,85,64,1],[86,9,86,72,1],[87,5,87,6,1],[91,5,91,6,1],[93,9,93,45,1],[94,9,94,70,1],[95,9,95,48,1],[97,9,97,67,1],[98,9,98,57,1],[99,9,99,53,1],[100,9,100,32,1],[101,9,101,50,1],[104,9,104,78,1],[107,9,107,43,1],[108,9,108,100,1],[109,9,109,40,1],[110,5,110,6,1],[118,5,118,6,1],[120,9,120,45,1],[121,9,121,70,1],[122,9,122,48,1],[124,9,128,11,1],[129,9,129,53,1],[130,9,130,50,1],[133,9,133,82,1],[136,9,136,43,1],[137,9,137,44,1],[138,5,138,6,1],[142,5,142,6,1],[144,9,144,45,1],[145,9,145,70,1],[146,9,146,48,1],[149,9,149,82,1],[152,9,152,43,1],[153,9,153,43,1],[154,9,154,41,1],[155,5,155,6,1],[159,5,159,6,1],[161,9,161,45,1],[162,9,162,70,1],[163,9,163,48,1],[166,9,170,11,1],[171,9,171,53,1],[172,9,172,50,1],[175,9,175,82,1],[178,9,178,43,1],[179,9,179,44,1],[180,9,180,59,1],[181,9,181,58,1],[182,9,182,59,1],[183,5,183,6,1],[187,5,187,6,1],[189,9,189,45,1],[190,9,190,70,1],[191,9,191,49,1],[192,9,192,49,1],[194,9,198,11,1],[199,9,199,53,1],[200,9,200,50,1],[203,9,203,83,1],[206,9,206,43,1],[207,9,207,44,1],[208,9,208,70,1],[209,5,209,6,1],[213,5,213,6,1],[215,9,215,45,1],[216,9,216,70,1],[219,9,219,80,1],[222,9,222,43,1],[223,9,223,41,1],[224,5,224,6,1],[232,5,232,6,1],[234,9,234,45,1],[235,9,235,70,1],[236,9,236,48,1],[238,9,238,91,1],[241,9,241,75,1],[244,9,244,43,1],[245,9,245,43,1],[246,9,246,51,1],[247,9,247,54,1],[248,9,248,69,1],[249,9,249,50,1],[250,5,250,6,1],[254,5,254,6,1],[256,9,256,45,1],[257,9,257,70,1],[258,9,258,48,1],[260,9,260,73,1],[263,9,263,81,1],[264,9,264,45,1],[265,9,265,50,1],[268,9,268,83,1],[271,9,271,48,1],[272,9,272,64,1],[273,5,273,6,1],[277,5,277,6,1],[279,9,279,45,1],[280,9,280,70,1],[281,9,281,48,1],[283,9,283,65,1],[284,9,284,65,1],[285,9,285,65,1],[288,9,288,77,1],[289,9,289,77,1],[290,9,290,77,1],[293,9,293,44,1],[294,9,294,44,1],[295,9,295,44,1],[297,9,297,82,1],[298,9,298,44,1],[299,5,299,6,1],[303,5,303,6,1],[305,9,305,45,1],[306,9,306,70,1],[307,9,307,48,1],[309,9,309,83,1],[312,9,312,75,1],[315,9,315,43,1],[316,9,316,52,1],[317,5,317,6,1],[321,5,321,6,1],[323,9,323,45,1],[324,9,324,70,1],[326,9,326,67,1],[329,9,329,75,1],[332,9,332,42,1],[333,5,333,6,1],[341,5,341,6,1],[343,9,343,45,1],[344,9,344,70,1],[345,9,345,48,1],[347,9,347,94,1],[348,9,348,57,1],[349,9,349,53,1],[350,9,350,32,1],[353,9,353,50,1],[356,9,356,105,1],[357,9,357,45,1],[358,9,358,59,1],[360,9,360,83,1],[363,9,363,43,1],[364,9,364,55,1],[365,9,365,69,1],[366,5,366,6,1],[370,5,370,6,1],[372,9,372,45,1],[373,9,373,70,1],[374,9,374,48,1],[376,9,376,70,1],[377,9,377,57,1],[378,9,378,53,1],[379,9,379,32,1],[380,9,380,50,1],[383,9,383,105,1],[384,9,384,49,1],[385,9,385,70,1],[386,9,386,50,1],[389,9,389,83,1],[392,9,392,48,1],[393,9,393,64,1],[394,5,394,6,1],[398,5,398,6,1],[400,9,400,45,1],[401,9,401,70,1],[402,9,402,48,1],[404,9,404,98,1],[405,9,405,57,1],[406,9,406,53,1],[407,9,407,32,1],[408,9,408,50,1],[411,9,411,105,1],[412,9,412,42,1],[413,9,413,83,1],[416,9,416,43,1],[417,9,417,52,1],[418,5,418,6,1],[426,5,426,6,1],[428,9,428,45,1],[429,9,429,70,1],[430,9,430,48,1],[432,9,432,70,1],[433,9,433,57,1],[434,9,434,53,1],[435,9,435,32,1],[436,9,436,50,1],[439,9,439,77,1],[442,9,442,43,1],[443,5,443,6,1],[447,5,447,6,1],[449,9,449,45,1],[450,9,450,70,1],[451,9,451,48,1],[453,9,453,69,1],[454,9,454,57,1],[455,9,455,53,1],[456,9,456,32,1],[457,9,457,50,1],[460,9,460,64,1],[461,9,461,50,1],[464,9,464,83,1],[467,9,467,47,1],[468,9,468,77,1],[469,5,469,6,1],[473,5,473,6,1],[475,9,475,45,1],[476,9,476,70,1],[479,9,479,75,1],[482,9,482,42,1],[483,9,483,72,1],[484,5,484,6,1],[488,5,488,6,1],[490,9,490,45,1],[491,9,491,70,1],[492,9,492,48,1],[494,9,494,65,1],[495,9,495,65,1],[496,9,496,65,1],[498,9,498,79,1],[499,9,499,53,1],[501,9,501,41,1],[502,9,502,50,1],[505,9,505,72,1],[506,9,506,50,1],[509,9,509,91,1],[512,9,512,52,1],[513,9,513,53,1],[514,9,514,81,1],[515,5,515,6,1],[523,5,523,6,1],[525,9,525,45,1],[526,9,526,70,1],[527,9,527,48,1],[529,9,529,67,1],[530,9,530,57,1],[531,9,531,53,1],[532,9,532,50,1],[535,9,535,82,1],[538,9,538,43,1],[541,9,541,100,1],[542,9,542,40,1],[543,5,543,6,1],[547,5,547,6,1],[549,9,549,45,1],[550,9,550,70,1],[551,9,551,48,1],[554,9,554,72,1],[555,9,555,57,1],[556,9,556,53,1],[557,9,557,32,1],[560,9,560,64,1],[561,9,561,50,1],[564,9,564,37,1],[567,9,567,75,1],[570,9,570,42,1],[571,9,571,64,1],[572,5,572,6,1],[576,5,576,6,1],[578,9,578,45,1],[579,9,579,70,1],[580,9,580,48,1],[582,9,582,57,1],[585,9,585,75,1],[588,9,588,43,1],[589,9,589,43,1],[590,9,590,51,1],[591,5,591,6,1],[599,5,599,6,1],[601,9,601,45,1],[602,9,602,70,1],[603,9,603,48,1],[606,9,606,94,1],[607,9,607,81,1],[608,9,608,49,1],[609,9,609,45,1],[610,9,610,50,1],[613,9,613,100,1],[614,9,614,50,1],[615,9,615,54,1],[616,9,616,84,1],[617,9,617,49,1],[618,9,618,50,1],[621,9,621,84,1],[622,9,622,49,1],[623,9,623,71,1],[624,9,624,75,1],[627,9,627,83,1],[628,9,628,49,1],[629,9,629,50,1],[632,9,632,83,1],[633,9,633,47,1],[634,5,634,6,1],[638,5,638,6,1],[640,9,640,45,1],[641,9,641,70,1],[643,9,643,49,1],[644,9,644,49,1],[647,9,647,106,1],[648,9,648,108,1],[649,9,649,108,1],[650,9,650,50,1],[653,9,653,88,1],[654,9,654,88,1],[657,9,657,48,1],[658,9,658,48,1],[660,9,660,49,1],[661,9,661,49,1],[663,9,663,75,1],[664,9,664,75,1],[665,5,665,6,1]]);
    </script>
  </body>
</html>